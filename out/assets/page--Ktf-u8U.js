import{j as e,L,u as R,c as P,r as c,s as x,b as A}from"./index-DIAhV4tm.js";const I={OPEN:{bg:"bg-sky-100 text-sky-700",label:"Abierto"},CLOSED:{bg:"bg-amber-100 text-amber-700",label:"Cerrado"},DISPATCHED:{bg:"bg-emerald-100 text-emerald-700",label:"Despachado"}};function C(d){const i=new Date(d);return Number.isNaN(i.getTime())?"Fecha no válida":i.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}function T({code:d,tienda:i,camion:o,status:l,createdAt:a,closedAt:m,createdByEmail:u}){const t=I[l]??{bg:"bg-gray-100 text-gray-700",label:l};return e.jsxs("div",{children:[e.jsxs(L,{to:"/contenedores",className:"text-teal-600 hover:text-teal-700 text-sm font-medium mb-3 inline-flex items-center cursor-pointer",children:[e.jsx("i",{className:"ri-arrow-left-line mr-1"}),"Volver a Contenedores"]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-5 mt-2",children:[e.jsxs("div",{className:"flex items-start justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-rose-500 to-rose-600 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-inbox-line text-2xl text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:d}),e.jsxs("p",{className:"text-sm text-gray-500 mt-0.5",children:["Tienda: ",e.jsx("strong",{className:"text-gray-700",children:i}),o&&e.jsxs(e.Fragment,{children:[" ","·"," ",e.jsxs("span",{className:"inline-flex items-center text-amber-600 font-medium",children:[e.jsx("i",{className:"ri-truck-line mr-1"}),o]})]})]})]})]}),e.jsx("span",{className:`px-3 py-1.5 rounded-full text-xs font-semibold ${t.bg}`,children:t.label})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mt-5 pt-5 border-t border-gray-100",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] uppercase tracking-wider text-gray-400 font-medium",children:"Creado"}),e.jsx("p",{className:"text-sm text-gray-800 mt-1",children:C(a)})]}),m&&e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] uppercase tracking-wider text-gray-400 font-medium",children:"Cerrado"}),e.jsx("p",{className:"text-sm text-gray-800 mt-1",children:C(m)})]}),u&&e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] uppercase tracking-wider text-gray-400 font-medium",children:"Creado por"}),e.jsx("p",{className:"text-sm text-gray-800 mt-1",children:u})]})]})]})]})}function M({totalPallets:d,totalSkus:i,totalUnits:o}){const l=[{label:"Pallets",value:d,icon:"ri-stack-line",gradient:"from-teal-500 to-cyan-600"},{label:"SKUs distintos",value:i,icon:"ri-barcode-line",gradient:"from-violet-500 to-purple-600"},{label:"Unidades totales",value:o.toLocaleString("es-ES"),icon:"ri-hashtag",gradient:"from-rose-500 to-pink-600"}];return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:l.map(a=>e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-5 flex items-center space-x-4",children:[e.jsx("div",{className:`w-11 h-11 bg-gradient-to-br ${a.gradient} rounded-lg flex items-center justify-center`,children:e.jsx("i",{className:`${a.icon} text-xl text-white`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:a.value}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:a.label})]})]},a.label))})}function $({rows:d,containerStatus:i,onReverse:o}){const l=i!=="DISPATCHED";return d.length===0?e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-50 rounded-2xl flex items-center justify-center mx-auto mb-4",children:e.jsx("i",{className:"ri-inbox-line text-3xl text-gray-400"})}),e.jsx("p",{className:"text-sm text-gray-600",children:"No hay líneas en este contenedor"})]}):e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Contenido del Contenedor"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[d.length," líneas registradas"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Pallet"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Ubicación"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"SKU"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Descripción"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Código de Barra"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Cantidad"}),l&&e.jsx("th",{className:"px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:d.map(a=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-lg flex items-center justify-center mr-3",children:e.jsx("i",{className:"ri-stack-line text-white text-sm"})}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:a.pallet_code})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-600",children:a.ubicacion||"—"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-sky-100 text-sky-700",children:a.sku})}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-900",children:a.descripcion||"—"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-600",children:a.barcode||"—"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:e.jsx("span",{className:"text-sm font-semibold text-teal-600",children:a.qty})}),l&&e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:e.jsxs("button",{onClick:()=>o?.(a.id),className:"inline-flex items-center px-3 py-1.5 bg-amber-50 text-amber-700 rounded-lg text-xs font-medium hover:bg-amber-100 transition-colors whitespace-nowrap cursor-pointer",title:"Reversar esta línea",children:[e.jsx("i",{className:"ri-arrow-go-back-line mr-1.5"}),"Reversar"]})})]},a.id))})]})})]})}function U({lineId:d,onClose:i,onSuccess:o}){const{user:l}=R(),{showToast:a}=P(),[m,u]=c.useState(!1),[t,S]=c.useState(null),[v,h]=c.useState("");c.useEffect(()=>{w()},[d]);const w=async()=>{try{const{data:r,error:p}=await x.from("container_lines").select(`
          id,
          container_id,
          pallet_id,
          sku,
          qty,
          source_import_line_id,
          pallets(pallet_code),
          import_lines:source_import_line_id(descripcion, tienda)
        `).eq("id",d).maybeSingle();if(p)throw p;if(!r){h("Línea no encontrada");return}S({id:r.id,container_id:r.container_id,pallet_id:r.pallet_id,sku:r.sku,qty:r.qty,source_import_line_id:r.source_import_line_id,pallet_code:r.pallets?.pallet_code||"—",descripcion:r.import_lines?.descripcion||"—",tienda:r.import_lines?.tienda||"—"})}catch(r){console.error("Error cargando detalles de línea:",r),h("Error al cargar los detalles")}},f=async()=>{if(!(!t||!l)){u(!0),h("");try{const{data:r}=await x.from("containers").select("status").eq("id",t.container_id).maybeSingle();if(!r)throw new Error("Contenedor no encontrado");if(r.status==="DISPATCHED")throw new Error("No se pueden reversar líneas de contenedores despachados");const{data:p}=await x.from("pallet_inventory").select("qty_available").eq("pallet_id",t.pallet_id).eq("sku",t.sku).maybeSingle();if(!p)throw new Error("Inventario del pallet no encontrado");const{error:g}=await x.from("pallet_inventory").update({qty_available:p.qty_available+t.qty}).eq("pallet_id",t.pallet_id).eq("sku",t.sku);if(g)throw g;const{data:j}=await x.from("import_lines").select("qty_confirmed, qty_to_send").eq("id",t.source_import_line_id).maybeSingle();if(!j)throw new Error("Línea de importación no encontrada");const N=Math.max(0,j.qty_confirmed-t.qty),_=N===0?"PENDING":N>=j.qty_to_send?"DONE":"PARTIAL",{error:k}=await x.from("import_lines").update({qty_confirmed:N,status:_,..._!=="DONE"?{done_at:null,done_by:null}:{}}).eq("id",t.source_import_line_id);if(k)throw k;const{error:E}=await x.from("container_lines").delete().eq("id",t.id);if(E)throw E;await x.from("scan_events").insert({pallet_id:t.pallet_id,event_type:"REVERSE",sku:t.sku,tienda:t.tienda,qty:t.qty,user_id:l.id,notes:"Reversión de línea de contenedor"}),a("success","Línea reversada",`${t.qty} uds de ${t.sku} devueltas al pallet ${t.pallet_code}`),o(),i()}catch(r){console.error("Error reversando línea:",r),h(r.message||"Error al reversar la línea"),a("error","Error",r.message||"No se pudo reversar la línea")}finally{u(!1)}}};return t?e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Reversar Línea"}),e.jsx("button",{onClick:i,disabled:m,className:"text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-2xl"})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-alert-line text-amber-600 text-xl mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-amber-900 mb-1",children:"Confirmar reversión"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Esta acción devolverá la cantidad al pallet de origen y actualizará el estado del pedido."})]})]})}),v&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm mb-6",children:v}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Pallet:"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:t.pallet_code})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"SKU:"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:t.sku})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Descripción:"}),e.jsx("span",{className:"text-sm text-gray-900",children:t.descripcion})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Tienda:"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:t.tienda})]}),e.jsxs("div",{className:"flex items-center justify-between py-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Cantidad a reversar:"}),e.jsxs("span",{className:"text-lg font-bold text-amber-600",children:[t.qty," uds"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:i,disabled:m,className:"flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors whitespace-nowrap cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancelar"}),e.jsx("button",{onClick:f,disabled:m,className:"flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-lg font-medium hover:from-amber-600 hover:to-amber-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap cursor-pointer",children:m?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line mr-2 animate-spin"}),"Reversando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-arrow-go-back-line mr-2"}),"Confirmar Reversión"]})})]})]})]})}):e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-6",children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-teal-500"})})})})}function F(){const{id:d}=A(),[i,o]=c.useState(null),[l,a]=c.useState([]),[m,u]=c.useState(""),[t,S]=c.useState(""),[v,h]=c.useState(!0),[w,f]=c.useState(""),[r,p]=c.useState(null);c.useEffect(()=>{d&&g()},[d]);const g=async()=>{h(!0),f("");try{const{data:s,error:n}=await x.from("containers").select(`
            id, code, tienda, status, created_at, closed_at, created_by,
            container_lines(
              id, qty, sku, pallet_id,
              pallets(id, pallet_code, ubicacion),
              import_lines:source_import_line_id(id, descripcion, barcode, tienda, camion)
            )
          `).eq("id",d).maybeSingle();if(n)throw n;if(!s){f("Contenedor no encontrado");return}o({id:s.id,code:s.code,tienda:s.tienda,status:s.status,created_at:s.created_at,closed_at:s.closed_at,created_by:s.created_by});const b=s.container_lines??[];if(a(b),b.length>0&&b[0].import_lines?.camion&&S(b[0].import_lines.camion),s.created_by){const{data:y,error:q}=await x.from("users").select("email, full_name").eq("auth_id",s.created_by).maybeSingle();if(q)throw q;y&&u(y.full_name||y.email)}}catch(s){console.error("Error cargando contenedor:",s),f("Error al cargar el contenedor")}finally{h(!1)}},j=s=>{p(s)},N=()=>{g()},_=c.useMemo(()=>{const s=new Map;return l.forEach(n=>{const b=n.pallets?.pallet_code??"—",y=`${b}|${n.sku}`;if(s.has(y)){const q=s.get(y);q.qty+=Number(n.qty)||0}else s.set(y,{id:n.id,pallet_code:b,ubicacion:n.pallets?.ubicacion??"",sku:n.sku,descripcion:n.import_lines?.descripcion??"",barcode:n.import_lines?.barcode??"",qty:Number(n.qty)||0})}),Array.from(s.values())},[l]),k=c.useMemo(()=>{const s=new Set;return l.forEach(n=>{n.pallet_id&&s.add(n.pallet_id)}),s.size},[l]),E=c.useMemo(()=>{const s=new Set;return l.forEach(n=>{n.sku&&s.add(n.sku)}),s.size},[l]),D=c.useMemo(()=>l.reduce((s,n)=>s+(Number(n.qty)||0),0),[l]);return v?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-teal-500"})}):w?e.jsxs("div",{className:"text-center py-20",children:[e.jsx("div",{className:"w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center mx-auto mb-4",children:e.jsx("i",{className:"ri-error-warning-line text-3xl text-red-400"})}),e.jsx("p",{className:"text-sm text-gray-600",children:w})]}):i?e.jsxs("div",{className:"space-y-6",children:[e.jsx(T,{code:i.code,tienda:i.tienda,camion:t,status:i.status,createdAt:i.created_at,closedAt:i.closed_at,createdByEmail:m}),e.jsx(M,{totalPallets:k,totalSkus:E,totalUnits:D}),e.jsx($,{rows:_,containerStatus:i.status,onReverse:j}),r&&e.jsx(U,{lineId:r,onClose:()=>p(null),onSuccess:N})]}):null}export{F as default};
//# sourceMappingURL=page--Ktf-u8U.js.map
