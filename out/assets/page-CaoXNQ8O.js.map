{"version":3,"file":"page-CaoXNQ8O.js","sources":["../../src/lib/containerService.ts","../../src/pages/operacion/components/TiendaChangePopup.tsx","../../src/pages/operacion/components/SobranteModal.tsx","../../src/pages/operacion/components/DistribucionModal.tsx","../../src/pages/operacion/page.tsx"],"sourcesContent":["import { supabase } from './supabase';\n\n/**\n * Genera el siguiente código consecutivo para contenedores\n * Formato: 22O00000001 (22O + 8 dígitos)\n */\nasync function generateContainerCode(): Promise<string> {\n  const prefix = '22O';\n  \n  // Obtener el último código generado\n  const { data: lastContainer } = await supabase\n    .from('containers')\n    .select('code')\n    .like('code', `${prefix}%`)\n    .order('code', { ascending: false })\n    .limit(1)\n    .maybeSingle();\n\n  let nextNumber = 1;\n  \n  if (lastContainer?.code) {\n    // Extraer el número del código anterior\n    const lastNumber = parseInt(lastContainer.code.substring(3), 10);\n    nextNumber = lastNumber + 1;\n  }\n\n  // Formatear con 8 dígitos\n  const paddedNumber = nextNumber.toString().padStart(8, '0');\n  return `${prefix}${paddedNumber}`;\n}\n\n/**\n * Obtiene o crea un contenedor OPEN para una tienda específica\n * Si existe un contenedor OPEN para esa tienda e import → lo reutiliza\n * Si no existe → crea uno nuevo con código consecutivo\n */\nexport async function getOrCreateOpenContainer(\n  importId: string,\n  tienda: string,\n  userId: string\n): Promise<string> {\n  const maxRetries = 3;\n  let attempt = 0;\n\n  while (attempt < maxRetries) {\n    try {\n      // 1. Buscar contenedor OPEN existente para esta tienda e import\n      const { data: existingContainer } = await supabase\n        .from('containers')\n        .select('id')\n        .eq('import_id', importId)\n        .eq('tienda', tienda)\n        .eq('status', 'OPEN')\n        .maybeSingle();\n\n      if (existingContainer) {\n        return existingContainer.id;\n      }\n\n      // 2. No existe → crear nuevo contenedor\n      const code = await generateContainerCode();\n\n      const { data: newContainer, error: insertError } = await supabase\n        .from('containers')\n        .insert({\n          code,\n          import_id: importId,\n          tienda,\n          status: 'OPEN',\n          created_by: userId,\n        })\n        .select('id')\n        .single();\n\n      if (insertError) {\n        // Si hay error de duplicado de código, reintentar\n        if (insertError.code === '23505') {\n          attempt++;\n          continue;\n        }\n        throw insertError;\n      }\n\n      return newContainer.id;\n    } catch (error) {\n      attempt++;\n      if (attempt >= maxRetries) {\n        throw new Error(`Error al crear contenedor después de ${maxRetries} intentos: ${error}`);\n      }\n      // Esperar un poco antes de reintentar\n      await new Promise(resolve => setTimeout(resolve, 100 * attempt));\n    }\n  }\n\n  throw new Error('No se pudo crear el contenedor');\n}\n\n/**\n * Verifica si un contenedor está en estado que permite agregar líneas\n */\nexport async function isContainerEditable(containerId: string): Promise<boolean> {\n  const { data: container } = await supabase\n    .from('containers')\n    .select('status')\n    .eq('id', containerId)\n    .maybeSingle();\n\n  return container?.status === 'OPEN';\n}\n\n/**\n * Obtiene todos los contenedores OPEN de un import\n */\nexport async function getOpenContainersByImport(importId: string) {\n  const { data, error } = await supabase\n    .from('containers')\n    .select('id, code, tienda, created_at')\n    .eq('import_id', importId)\n    .eq('status', 'OPEN')\n    .order('created_at', { ascending: false });\n\n  if (error) throw error;\n  return data || [];\n}\n\n/**\n * Valida y registra una línea en el contenedor con validaciones de concurrencia\n * Retorna true si se insertó correctamente, false si hubo error\n */\nexport async function addContainerLineWithValidation(\n  containerId: string,\n  palletId: string,\n  sku: string,\n  qty: number,\n  sourceImportLineId: string\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    // ✅ VALIDACIÓN 1: Verificar que el contenedor esté OPEN\n    const { data: container } = await supabase\n      .from('containers')\n      .select('status')\n      .eq('id', containerId)\n      .maybeSingle();\n\n    if (!container) {\n      return { success: false, error: 'Contenedor no encontrado' };\n    }\n\n    if (container.status !== 'OPEN') {\n      return { success: false, error: `El contenedor está en estado ${container.status} y no permite agregar líneas` };\n    }\n\n    // ✅ VALIDACIÓN 2: Verificar inventario disponible en tiempo real\n    const { data: inventory } = await supabase\n      .from('pallet_inventory')\n      .select('qty_available')\n      .eq('pallet_id', palletId)\n      .eq('sku', sku)\n      .maybeSingle();\n\n    if (!inventory || inventory.qty_available < qty) {\n      return { success: false, error: 'Cantidad no disponible en inventario del pallet' };\n    }\n\n    // ✅ VALIDACIÓN 3: Verificar pendiente de la línea de importación\n    const { data: importLine } = await supabase\n      .from('import_lines')\n      .select('qty_to_send, qty_confirmed')\n      .eq('id', sourceImportLineId)\n      .maybeSingle();\n\n    if (!importLine) {\n      return { success: false, error: 'Línea de importación no encontrada' };\n    }\n\n    const pending = importLine.qty_to_send - importLine.qty_confirmed;\n    if (qty > pending) {\n      return { success: false, error: 'Cantidad mayor al pendiente del pedido' };\n    }\n\n    // ✅ INSERTAR LÍNEA EN CONTENEDOR\n    const { error: insertError } = await supabase\n      .from('container_lines')\n      .insert({\n        container_id: containerId,\n        pallet_id: palletId,\n        sku,\n        qty,\n        source_import_line_id: sourceImportLineId,\n      });\n\n    if (insertError) {\n      return { success: false, error: `Error al insertar línea: ${insertError.message}` };\n    }\n\n    return { success: true };\n  } catch (error) {\n    console.error('Error en addContainerLineWithValidation:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Error desconocido' };\n  }\n}\n\n/**\n * Cierra un contenedor y valida que tenga líneas\n */\nexport async function closeContainer(\n  containerId: string,\n  userId: string\n): Promise<{ success: boolean; error?: string; code?: string; lineCount?: number }> {\n  try {\n    // ✅ VALIDACIÓN 1: Verificar que el contenedor exista y esté OPEN\n    const { data: container } = await supabase\n      .from('containers')\n      .select('id, code, status')\n      .eq('id', containerId)\n      .maybeSingle();\n\n    if (!container) {\n      return { success: false, error: 'Contenedor no encontrado' };\n    }\n\n    if (container.status !== 'OPEN') {\n      return { success: false, error: `El contenedor ya está en estado ${container.status}` };\n    }\n\n    // ✅ VALIDACIÓN 2: Verificar que tenga líneas\n    const { data: lines, count } = await supabase\n      .from('container_lines')\n      .select('id', { count: 'exact' })\n      .eq('container_id', containerId);\n\n    if (!count || count === 0) {\n      return { success: false, error: 'El contenedor no tiene líneas. Confirma cantidades antes de cerrar.' };\n    }\n\n    // ✅ CERRAR CONTENEDOR\n    const { error: updateError } = await supabase\n      .from('containers')\n      .update({\n        status: 'CLOSED',\n        closed_at: new Date().toISOString(),\n      })\n      .eq('id', containerId);\n\n    if (updateError) {\n      return { success: false, error: `Error al cerrar contenedor: ${updateError.message}` };\n    }\n\n    return { success: true, code: container.code, lineCount: count };\n  } catch (error) {\n    console.error('Error en closeContainer:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Error desconocido' };\n  }\n}\n","\nimport { useEffect, useState } from 'react';\n\ninterface Props {\n  previousTienda: string;\n  newTienda: string;\n  sku: string;\n  onClose: () => void;\n}\n\nexport default function TiendaChangePopup({ previousTienda, newTienda, sku, onClose }: Props) {\n  const [isVisible, setIsVisible] = useState(false);\n\n  useEffect(() => {\n    requestAnimationFrame(() => setIsVisible(true));\n  }, []);\n\n  const handleClose = () => {\n    setIsVisible(false);\n    setTimeout(onClose, 250);\n  };\n\n  return (\n    <div\n      className={`fixed inset-0 z-[70] flex items-center justify-center p-4 transition-all duration-250 ${isVisible ? 'bg-black/40' : 'bg-black/0'}`}\n      onClick={handleClose}\n    >\n      <div\n        className={`bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden transition-all duration-250 ${isVisible ? 'scale-100 opacity-100' : 'scale-95 opacity-0'}`}\n        onClick={(e) => e.stopPropagation()}\n      >\n        <div className=\"bg-gradient-to-r from-sky-500 to-cyan-500 px-6 py-5 text-center\">\n          <div className=\"w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-3\">\n            <i className=\"ri-store-2-line text-3xl text-white\"></i>\n          </div>\n          <h3 className=\"text-lg font-bold text-white\">Cambio de Tienda</h3>\n        </div>\n\n        <div className=\"px-6 py-5\">\n          <p className=\"text-sm text-gray-500 text-center mb-5\">\n            El SKU <span className=\"font-semibold text-gray-800\">{sku}</span> ahora se distribuye a otra tienda\n          </p>\n\n          <div className=\"flex items-center justify-center gap-3 mb-5\">\n            <div className=\"flex-1 text-center bg-gray-50 rounded-xl py-3 px-2 border border-gray-100\">\n              <p className=\"text-[10px] uppercase tracking-wider text-gray-400 font-medium mb-1\">Anterior</p>\n              <p className=\"text-sm font-bold text-gray-700\">{previousTienda}</p>\n            </div>\n            <div className=\"w-8 h-8 flex items-center justify-center flex-shrink-0\">\n              <i className=\"ri-arrow-right-line text-xl text-sky-500\"></i>\n            </div>\n            <div className=\"flex-1 text-center bg-sky-50 rounded-xl py-3 px-2 border border-sky-100\">\n              <p className=\"text-[10px] uppercase tracking-wider text-sky-400 font-medium mb-1\">Nueva</p>\n              <p className=\"text-sm font-bold text-sky-700\">{newTienda}</p>\n            </div>\n          </div>\n\n          <button\n            onClick={handleClose}\n            className=\"w-full py-3 bg-gradient-to-r from-sky-500 to-cyan-500 text-white rounded-xl font-medium text-sm hover:from-sky-600 hover:to-cyan-600 transition-all whitespace-nowrap cursor-pointer\"\n          >\n            Entendido\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","\nimport { useState, useEffect } from 'react';\nimport { supabase, Pallet } from '../../../lib/supabase';\nimport { useAuth } from '../../../contexts/AuthContext';\nimport { useToast } from '../../../components/base/Toast';\n\ninterface InventoryItem {\n  id: string;\n  pallet_id: string;\n  sku: string;\n  qty_initial: number;\n  qty_available: number;\n}\n\ninterface SobranteEntry {\n  sku: string;\n  qty_available: number;\n  qty_sobrante: number;\n}\n\ninterface Props {\n  pallet: Pallet;\n  importId: string;\n  onClose: () => void;\n  onComplete: () => void;\n}\n\nexport default function SobranteModal({ pallet, importId, onClose, onComplete }: Props) {\n  const { user } = useAuth();\n  const { showToast } = useToast();\n  const [loading, setLoading] = useState(true);\n  const [submitting, setSubmitting] = useState(false);\n  const [entries, setEntries] = useState<SobranteEntry[]>([]);\n  const [containerCode, setContainerCode] = useState('');\n  const [step, setStep] = useState<'review' | 'confirm'>('review');\n\n  useEffect(() => {\n    loadRemainingInventory();\n  }, []);\n\n  const loadRemainingInventory = async () => {\n    setLoading(true);\n    try {\n      const { data: inventory } = await supabase\n        .from('pallet_inventory')\n        .select('*')\n        .eq('pallet_id', pallet.id)\n        .gt('qty_available', 0);\n\n      if (!inventory || inventory.length === 0) {\n        showToast('info', 'Sin sobrantes', 'No hay inventario disponible en este pallet');\n        onClose();\n        return;\n      }\n\n      const items: SobranteEntry[] = inventory.map((inv: InventoryItem) => ({\n        sku: inv.sku,\n        qty_available: inv.qty_available,\n        qty_sobrante: inv.qty_available,\n      }));\n\n      setEntries(items);\n    } catch (err) {\n      showToast('error', 'Error', 'No se pudo cargar el inventario restante');\n      onClose();\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const updateQty = (index: number, value: string) => {\n    const qty = parseFloat(value) || 0;\n    setEntries((prev) =>\n      prev.map((entry, i) =>\n        i === index\n          ? { ...entry, qty_sobrante: Math.min(Math.max(0, qty), entry.qty_available) }\n          : entry\n      )\n    );\n  };\n\n  const totalSobrante = entries.reduce((sum, e) => sum + e.qty_sobrante, 0);\n  const hasValidEntries = entries.some((e) => e.qty_sobrante > 0);\n\n  const generateSurplusContainerCode = async (): Promise<string> => {\n    const prefix = 'SOB';\n    const { data: lastContainer } = await supabase\n      .from('containers')\n      .select('code')\n      .like('code', `${prefix}%`)\n      .order('code', { ascending: false })\n      .limit(1)\n      .maybeSingle();\n\n    let nextNumber = 1;\n    if (lastContainer?.code) {\n      const lastNumber = parseInt(lastContainer.code.substring(3), 10);\n      nextNumber = lastNumber + 1;\n    }\n    return `${prefix}${nextNumber.toString().padStart(8, '0')}`;\n  };\n\n  const handleSubmit = async () => {\n    if (!user || !hasValidEntries) return;\n    setSubmitting(true);\n\n    try {\n      const code = await generateSurplusContainerCode();\n      setContainerCode(code);\n\n      // Crear contenedor de sobrante\n      const { data: newContainer, error: containerError } = await supabase\n        .from('containers')\n        .insert({\n          code,\n          import_id: importId,\n          tienda: 'SOBRANTE',\n          status: 'CLOSED',\n          type: 'SOBRANTE',\n          created_by: user.id,\n          closed_at: new Date().toISOString(),\n        })\n        .select('id')\n        .single();\n\n      if (containerError) throw containerError;\n\n      // Insertar líneas del sobrante y descontar inventario\n      for (const entry of entries) {\n        if (entry.qty_sobrante <= 0) continue;\n\n        // Insertar línea en contenedor\n        const { error: lineError } = await supabase\n          .from('container_lines')\n          .insert({\n            container_id: newContainer.id,\n            pallet_id: pallet.id,\n            sku: entry.sku,\n            qty: entry.qty_sobrante,\n            source_import_line_id: null,\n          });\n        if (lineError) throw lineError;\n\n        // Descontar del inventario del pallet\n        const { data: currentInv } = await supabase\n          .from('pallet_inventory')\n          .select('qty_available')\n          .eq('pallet_id', pallet.id)\n          .eq('sku', entry.sku)\n          .maybeSingle();\n\n        if (currentInv) {\n          const newAvailable = Math.max(0, currentInv.qty_available - entry.qty_sobrante);\n          await supabase\n            .from('pallet_inventory')\n            .update({ qty_available: newAvailable })\n            .eq('pallet_id', pallet.id)\n            .eq('sku', entry.sku);\n        }\n\n        // Registrar evento de escaneo\n        await supabase.from('scan_events').insert({\n          pallet_id: pallet.id,\n          event_type: 'ADJUST',\n          sku: entry.sku,\n          tienda: 'SOBRANTE',\n          qty: entry.qty_sobrante,\n          notes: `Sobrante reportado en contenedor ${code}`,\n          user_id: user.id,\n        });\n      }\n\n      // Registrar movimiento de distribución para cada SKU sobrante\n      for (const entry of entries) {\n        if (entry.qty_sobrante <= 0) continue;\n        await supabase.from('distribution_moves').insert({\n          import_id: importId,\n          pallet_id: pallet.id,\n          sku: entry.sku,\n          tienda: 'SOBRANTE',\n          qty: entry.qty_sobrante,\n          user_id: user.id,\n          source_import_line_id: '00000000-0000-0000-0000-000000000000',\n        });\n      }\n\n      setStep('confirm');\n      showToast('success', 'Sobrante registrado', `Contenedor ${code} creado con ${totalSobrante} unidades`);\n    } catch (err) {\n      console.error('Error al reportar sobrante:', err);\n      showToast('error', 'Error', err instanceof Error ? err.message : 'No se pudo registrar el sobrante');\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"fixed inset-0 bg-black/50 flex items-end md:items-center justify-center z-[60]\">\n      <div className=\"bg-white w-full md:max-w-lg md:rounded-xl shadow-xl flex flex-col max-h-[90vh] rounded-t-2xl\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between px-4 py-3 md:px-6 md:py-4 border-b border-gray-200 flex-shrink-0\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-9 h-9 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center\">\n              <i className=\"ri-archive-2-line text-white text-lg\"></i>\n            </div>\n            <div>\n              <h2 className=\"text-base md:text-lg font-bold text-gray-900\">Reportar Sobrante</h2>\n              <p className=\"text-xs text-gray-500 font-mono\">{pallet.pallet_code}</p>\n            </div>\n          </div>\n          <button\n            onClick={step === 'confirm' ? onComplete : onClose}\n            className=\"w-9 h-9 flex items-center justify-center rounded-lg text-gray-400 hover:bg-gray-100 cursor-pointer\"\n          >\n            <i className=\"ri-close-line text-xl\"></i>\n          </button>\n        </div>\n\n        {/* Body */}\n        <div className=\"flex-1 overflow-y-auto p-4 md:p-6\">\n          {loading ? (\n            <div className=\"flex flex-col items-center justify-center py-12\">\n              <i className=\"ri-loader-4-line animate-spin text-3xl text-teal-500 mb-3\"></i>\n              <p className=\"text-sm text-gray-500\">Cargando inventario...</p>\n            </div>\n          ) : step === 'review' ? (\n            <div className=\"space-y-4\">\n              {/* Info banner */}\n              <div className=\"bg-amber-50 border border-amber-200 rounded-xl p-3.5 flex items-start gap-2.5\">\n                <i className=\"ri-information-line text-amber-600 text-lg flex-shrink-0 mt-0.5\"></i>\n                <div>\n                  <p className=\"text-sm font-semibold text-amber-800\">Mercadería sobrante detectada</p>\n                  <p className=\"text-xs text-amber-700 mt-0.5\">\n                    Estos SKUs tienen inventario disponible después de completar la distribución. \n                    Confirma las cantidades sobrantes para registrarlas en un contenedor de sobrantes.\n                  </p>\n                </div>\n              </div>\n\n              {/* SKU entries */}\n              <div className=\"space-y-3\">\n                {entries.map((entry, index) => (\n                  <div\n                    key={entry.sku}\n                    className=\"bg-gray-50 border border-gray-200 rounded-xl p-4\"\n                  >\n                    <div className=\"flex items-center justify-between mb-3\">\n                      <div>\n                        <span className=\"text-sm font-bold text-gray-900 font-mono\">{entry.sku}</span>\n                        <p className=\"text-xs text-gray-500 mt-0.5\">\n                          Disponible en pallet: <strong className=\"text-amber-600\">{entry.qty_available}</strong> uds\n                        </p>\n                      </div>\n                    </div>\n                    <div>\n                      <label className=\"block text-xs font-semibold text-gray-600 mb-1.5\">\n                        Cantidad sobrante\n                      </label>\n                      <div className=\"flex items-center gap-2\">\n                        <button\n                          onClick={() => updateQty(index, String(Math.max(0, entry.qty_sobrante - 1)))}\n                          className=\"w-11 h-11 flex items-center justify-center bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 active:bg-gray-100 cursor-pointer transition-colors\"\n                        >\n                          <i className=\"ri-subtract-line text-lg\"></i>\n                        </button>\n                        <input\n                          type=\"number\"\n                          value={entry.qty_sobrante || ''}\n                          onChange={(e) => updateQty(index, e.target.value)}\n                          className=\"flex-1 px-3 py-2.5 border-2 border-gray-200 rounded-xl text-center text-xl font-bold text-gray-900 focus:ring-2 focus:ring-amber-500 focus:border-amber-500\"\n                          min=\"0\"\n                          max={entry.qty_available}\n                          step=\"1\"\n                          inputMode=\"numeric\"\n                        />\n                        <button\n                          onClick={() => updateQty(index, String(Math.min(entry.qty_available, entry.qty_sobrante + 1)))}\n                          className=\"w-11 h-11 flex items-center justify-center bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 active:bg-gray-100 cursor-pointer transition-colors\"\n                        >\n                          <i className=\"ri-add-line text-lg\"></i>\n                        </button>\n                      </div>\n                      {/* Quick fill button */}\n                      <button\n                        onClick={() => updateQty(index, String(entry.qty_available))}\n                        className=\"mt-2 w-full py-1.5 text-xs font-medium text-amber-700 bg-amber-50 border border-amber-200 rounded-lg hover:bg-amber-100 transition-colors cursor-pointer\"\n                      >\n                        Usar todo el disponible ({entry.qty_available})\n                      </button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n\n              {/* Summary */}\n              <div className=\"bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-xs font-semibold text-gray-500 uppercase tracking-wider\">Total Sobrante</p>\n                    <p className=\"text-xs text-gray-500 mt-0.5\">{entries.filter(e => e.qty_sobrante > 0).length} SKU(s)</p>\n                  </div>\n                  <span className=\"text-3xl font-bold text-amber-600\">{totalSobrante}</span>\n                </div>\n              </div>\n            </div>\n          ) : (\n            /* ── Confirmation step ── */\n            <div className=\"flex flex-col items-center py-6\">\n              <div className=\"w-20 h-20 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full flex items-center justify-center mb-5\">\n                <i className=\"ri-checkbox-circle-line text-4xl text-white\"></i>\n              </div>\n              <h3 className=\"text-xl font-bold text-gray-900 mb-2\">Sobrante Registrado</h3>\n              <p className=\"text-sm text-gray-500 text-center mb-6\">\n                Se creó el contenedor de sobrantes exitosamente\n              </p>\n\n              <div className=\"w-full bg-gray-50 border border-gray-200 rounded-xl p-4 space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-gray-500\">Contenedor</span>\n                  <span className=\"text-sm font-bold text-gray-900 font-mono\">{containerCode}</span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-gray-500\">Tipo</span>\n                  <span className=\"px-2.5 py-0.5 bg-amber-100 text-amber-700 text-xs font-semibold rounded-full\">\n                    SOBRANTE\n                  </span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-gray-500\">Total unidades</span>\n                  <span className=\"text-sm font-bold text-amber-600\">{totalSobrante}</span>\n                </div>\n                <div className=\"border-t border-gray-200 pt-3\">\n                  <p className=\"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2\">Detalle</p>\n                  {entries.filter(e => e.qty_sobrante > 0).map((entry) => (\n                    <div key={entry.sku} className=\"flex items-center justify-between py-1.5\">\n                      <span className=\"text-sm font-mono text-gray-700\">{entry.sku}</span>\n                      <span className=\"text-sm font-semibold text-gray-900\">{entry.qty_sobrante} uds</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Footer */}\n        <div className=\"px-4 py-3 md:px-6 md:py-4 border-t border-gray-100 flex-shrink-0\">\n          {step === 'review' ? (\n            <div className=\"flex gap-3\">\n              <button\n                onClick={onClose}\n                className=\"flex-1 py-3.5 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors cursor-pointer text-sm whitespace-nowrap\"\n              >\n                Cancelar\n              </button>\n              <button\n                onClick={handleSubmit}\n                disabled={!hasValidEntries || submitting}\n                className=\"flex-1 py-3.5 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-xl font-semibold hover:from-amber-600 hover:to-orange-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer text-sm flex items-center justify-center gap-2 whitespace-nowrap\"\n              >\n                {submitting ? (\n                  <><i className=\"ri-loader-4-line animate-spin\"></i>Registrando...</>\n                ) : (\n                  <><i className=\"ri-archive-2-line\"></i>Registrar Sobrante</>\n                )}\n              </button>\n            </div>\n          ) : (\n            <button\n              onClick={onComplete}\n              className=\"w-full py-3.5 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-xl font-semibold hover:from-teal-600 hover:to-cyan-700 transition-all cursor-pointer text-sm flex items-center justify-center gap-2 whitespace-nowrap\"\n            >\n              <i className=\"ri-check-line text-lg\"></i>\n              Finalizar\n            </button>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","import { useState, useRef, useEffect } from 'react';\nimport { supabase, Pallet, PalletInventory, ImportLine } from '../../../lib/supabase';\nimport { getOrCreateOpenContainer, isContainerEditable } from '../../../lib/containerService';\nimport { useAuth } from '../../../contexts/AuthContext';\nimport { useToast } from '../../../components/base/Toast';\nimport TiendaChangePopup from './TiendaChangePopup';\nimport SobranteModal from './SobranteModal';\n\ninterface Props {\n  pallet: Pallet;\n  inventory: PalletInventory[];\n  pendingLines: ImportLine[];\n  onClose: () => void;\n  onComplete: () => void;\n}\n\ninterface TiendaProgress {\n  tienda: string;\n  camion: string;\n  qty_to_send: number;\n  qty_confirmed: number;\n  pending: number;\n  status: 'PENDING' | 'PARTIAL' | 'DONE';\n  importLineId: string;\n}\n\nexport default function DistribucionModal({ pallet, inventory, pendingLines, onClose, onComplete }: Props) {\n  const { user, loading: authLoading } = useAuth();\n  const { showToast } = useToast();\n  const [step, setStep] = useState<'scan' | 'confirm'>('scan');\n  const [skuInput, setSkuInput] = useState('');\n  const [selectedSku, setSelectedSku] = useState('');\n  const [selectedLine, setSelectedLine] = useState<ImportLine | null>(null);\n  const [quantity, setQuantity] = useState('');\n  const [error, setError] = useState('');\n  const [showCloseModal, setShowCloseModal] = useState(false);\n  const [showSobrante, setShowSobrante] = useState(false);\n  const [remainingInventory, setRemainingInventory] = useState<PalletInventory[]>([]);\n  const [resolvedImportId, setResolvedImportId] = useState<string>('');\n  const [selectedTiendaToClose, setSelectedTiendaToClose] = useState('');\n  const [closingInProgress, setClosingInProgress] = useState(false);\n  const [availableTiendas, setAvailableTiendas] = useState<string[]>([]);\n  const [selectedStore, setSelectedStore] = useState<string>('');\n  const [manualStoreSelection, setManualStoreSelection] = useState(false);\n  const [skuProgress, setSkuProgress] = useState<{ total: number; confirmed: number; percentage: number } | null>(null);\n  const [tiendasProgress, setTiendasProgress] = useState<TiendaProgress[]>([]);\n  const [skuLinesCache, setSkuLinesCache] = useState<ImportLine[]>([]);\n  const [tiendaChange, setTiendaChange] = useState<{ prev: string; next: string; sku: string } | null>(null);\n  const previousTiendaRef = useRef<string | null>(null);\n\n  const skuInputRef = useRef<HTMLInputElement>(null);\n  const qtyInputRef = useRef<HTMLInputElement>(null);\n\n  const hasUser = !authLoading && user !== null;\n\n  // Auto-focus SKU input when on scan step\n  useEffect(() => {\n    if (step === 'scan') {\n      setTimeout(() => skuInputRef.current?.focus(), 100);\n    }\n  }, [step]);\n\n  // Auto-focus quantity input when on confirm step\n  useEffect(() => {\n    if (step === 'confirm') {\n      setTimeout(() => qtyInputRef.current?.focus(), 150);\n    }\n  }, [step, selectedStore]);\n\n  useEffect(() => {\n    if (selectedSku && step === 'confirm') {\n      loadSkuProgress();\n    } else {\n      setSkuProgress(null);\n      setTiendasProgress([]);\n      setSkuLinesCache([]);\n    }\n  }, [selectedSku, step]);\n\n  // Resolve import_id on mount — works even if pendingLines is empty\n  useEffect(() => {\n    const resolve = async () => {\n      if (pendingLines.length > 0) {\n        setResolvedImportId(pendingLines[0].import_id);\n        return;\n      }\n      // Fallback: get import_id from any import_line for this pallet\n      const { data } = await supabase\n        .from('import_lines')\n        .select('import_id')\n        .eq('pallet_code', pallet.pallet_code)\n        .limit(1)\n        .maybeSingle();\n      if (data) setResolvedImportId(data.import_id);\n    };\n    resolve();\n  }, [pendingLines, pallet.pallet_code]);\n\n  const loadSkuProgress = async () => {\n    try {\n      const { data: lines } = await supabase\n        .from('import_lines')\n        .select('*')\n        .eq('pallet_code', pallet.pallet_code)\n        .eq('sku', selectedSku)\n        .order('tienda', { ascending: true });\n\n      if (!lines || lines.length === 0) return;\n\n      setSkuLinesCache(lines);\n\n      const total = lines.reduce((sum, l) => sum + l.qty_to_send, 0);\n      const confirmed = lines.reduce((sum, l) => sum + l.qty_confirmed, 0);\n      const percentage = total > 0 ? Math.round((confirmed / total) * 100) : 0;\n\n      setSkuProgress({ total, confirmed, percentage });\n\n      const tiendas: TiendaProgress[] = lines.map((line) => ({\n        tienda: line.tienda,\n        camion: line.camion || '',\n        qty_to_send: line.qty_to_send,\n        qty_confirmed: line.qty_confirmed,\n        pending: line.qty_to_send - line.qty_confirmed,\n        status: line.status,\n        importLineId: line.id,\n      }));\n\n      setTiendasProgress(tiendas);\n    } catch (err) {\n      console.error('Error cargando progreso del SKU:', err);\n    }\n  };\n\n  const getNextPendingLine = async (sku: string): Promise<ImportLine | null> => {\n    try {\n      const { data: lines } = await supabase\n        .from('import_lines')\n        .select('*')\n        .eq('pallet_code', pallet.pallet_code)\n        .eq('sku', sku)\n        .in('status', ['PENDING', 'PARTIAL'])\n        .order('tienda', { ascending: true });\n\n      if (!lines || lines.length === 0) return null;\n      return lines.find((l) => l.qty_confirmed < l.qty_to_send) || null;\n    } catch (err) {\n      return null;\n    }\n  };\n\n  const handleStoreClick = (tienda: TiendaProgress) => {\n    if (tienda.pending <= 0) {\n      showToast('warning', 'Tienda completa', `${tienda.tienda} ya tiene todas las unidades confirmadas`);\n      return;\n    }\n    const line = skuLinesCache.find((l) => l.tienda === tienda.tienda);\n    if (!line) return;\n\n    const prevStore = selectedStore;\n    setSelectedStore(tienda.tienda);\n    setSelectedLine(line);\n    setManualStoreSelection(true);\n    setQuantity('');\n    setError('');\n\n    if (prevStore && prevStore !== tienda.tienda) {\n      showToast('info', 'Tienda cambiada', `Ahora distribuyendo a ${tienda.tienda}`);\n    }\n    setTimeout(() => qtyInputRef.current?.focus(), 100);\n  };\n\n  const handleBackToAuto = async () => {\n    setManualStoreSelection(false);\n    const nextLine = await getNextPendingLine(selectedSku);\n    if (nextLine) {\n      setSelectedLine(nextLine);\n      setSelectedStore(nextLine.tienda);\n      setQuantity('');\n      setError('');\n      showToast('info', 'Modo automático', `Tienda activa: ${nextLine.tienda}`);\n      setTimeout(() => qtyInputRef.current?.focus(), 100);\n    }\n  };\n\n  const handleSkuSubmit = async (e?: React.FormEvent) => {\n    e?.preventDefault();\n    const code = skuInput.trim();\n    if (!code) return;\n\n    setError('');\n\n    let resolvedSku = code;\n    let inv = inventory.find((i) => i.sku === code);\n\n    if (!inv) {\n      const { data: lineByBarcode } = await supabase\n        .from('import_lines')\n        .select('sku')\n        .eq('barcode', code)\n        .eq('pallet_code', pallet.pallet_code)\n        .limit(1)\n        .maybeSingle();\n\n      if (lineByBarcode) {\n        resolvedSku = lineByBarcode.sku;\n        inv = inventory.find((i) => i.sku === resolvedSku);\n      }\n    }\n\n    if (!inv) {\n      setError('SKU / código de barra no encontrado en este pallet');\n      setSkuInput('');\n      skuInputRef.current?.focus();\n      return;\n    }\n\n    const { data: currentInv } = await supabase\n      .from('pallet_inventory')\n      .select('*')\n      .eq('id', inv.id)\n      .maybeSingle();\n\n    if (!currentInv || currentInv.qty_available <= 0) {\n      setError('No hay cantidad disponible para este SKU en el pallet');\n      setSkuInput('');\n      skuInputRef.current?.focus();\n      return;\n    }\n\n    const { data: allLines } = await supabase\n      .from('import_lines')\n      .select('*')\n      .eq('pallet_code', pallet.pallet_code)\n      .eq('sku', resolvedSku)\n      .in('status', ['PENDING', 'PARTIAL'])\n      .order('tienda', { ascending: true });\n\n    if (!allLines || allLines.length === 0) {\n      setError('No hay pedidos pendientes para este SKU');\n      setSkuInput('');\n      skuInputRef.current?.focus();\n      return;\n    }\n\n    const defaultLine = allLines.find((l) => l.qty_confirmed < l.qty_to_send);\n    if (!defaultLine) {\n      setError('No hay pedidos pendientes para este SKU');\n      setSkuInput('');\n      skuInputRef.current?.focus();\n      return;\n    }\n\n    setSkuLinesCache(allLines);\n\n    if (hasUser) {\n      await supabase.from('scan_events').insert({\n        pallet_id: pallet.id,\n        event_type: 'SCAN_SKU',\n        raw_code: code,\n        sku: resolvedSku,\n        tienda: defaultLine.tienda,\n        user_id: user.id,\n      });\n    }\n\n    previousTiendaRef.current = defaultLine.tienda;\n    setSelectedSku(resolvedSku);\n    setSelectedLine(defaultLine);\n    setSelectedStore(defaultLine.tienda);\n    setManualStoreSelection(false);\n    setSkuInput('');\n    setStep('confirm');\n  };\n\n  const checkRemainingInventory = async () => {\n    const { data: inv } = await supabase\n      .from('pallet_inventory')\n      .select('*')\n      .eq('pallet_id', pallet.id)\n      .gt('qty_available', 0);\n    setRemainingInventory(inv ?? []);\n    return inv ?? [];\n  };\n\n  // Check remaining inventory periodically when on scan step\n  useEffect(() => {\n    if (step === 'scan' && !selectedSku) {\n      checkRemainingInventory();\n    }\n  }, [step, selectedSku]);\n\n  const handleConfirm = async (e?: React.FormEvent) => {\n    e?.preventDefault();\n\n    if (!hasUser) {\n      setError('Sesión no cargada. Por favor, vuelve a iniciar sesión.');\n      return;\n    }\n\n    if (!selectedLine || !quantity) return;\n\n    const qty = parseFloat(quantity);\n    if (qty <= 0) { setError('La cantidad debe ser mayor a 0'); return; }\n\n    const pending = selectedLine.qty_to_send - selectedLine.qty_confirmed;\n    if (pending <= 0) { setError('Esta línea ya está completa'); return; }\n\n    const { data: currentInv } = await supabase\n      .from('pallet_inventory')\n      .select('*')\n      .eq('pallet_id', pallet.id)\n      .eq('sku', selectedSku)\n      .maybeSingle();\n\n    if (!currentInv || qty > currentInv.qty_available) { setError('Cantidad mayor al disponible en pallet'); return; }\n    if (qty > pending) { setError('Cantidad mayor al pendiente del pedido'); return; }\n\n    try {\n      const containerId = await getOrCreateOpenContainer(selectedLine.import_id, selectedLine.tienda, user!.id);\n      const editable = await isContainerEditable(containerId);\n      if (!editable) { setError('El contenedor de esta tienda ya está cerrado'); return; }\n\n      const { error: invError } = await supabase\n        .from('pallet_inventory')\n        .update({ qty_available: currentInv.qty_available - qty })\n        .eq('id', currentInv.id);\n      if (invError) throw invError;\n\n      const newConfirmed = selectedLine.qty_confirmed + qty;\n      const newStatus = newConfirmed >= selectedLine.qty_to_send ? 'DONE' : 'PARTIAL';\n\n      const { error: lineError } = await supabase\n        .from('import_lines')\n        .update({\n          qty_confirmed: newConfirmed,\n          status: newStatus,\n          ...(newStatus === 'DONE' ? { done_at: new Date().toISOString(), done_by: user!.id } : {}),\n        })\n        .eq('id', selectedLine.id);\n      if (lineError) throw lineError;\n\n      const { error: containerLineError } = await supabase.from('container_lines').insert({\n        container_id: containerId,\n        pallet_id: pallet.id,\n        sku: selectedSku,\n        qty,\n        source_import_line_id: selectedLine.id,\n      });\n      if (containerLineError) throw containerLineError;\n\n      const { error: moveError } = await supabase.from('distribution_moves').insert({\n        import_id: selectedLine.import_id,\n        pallet_id: pallet.id,\n        sku: selectedSku,\n        tienda: selectedLine.tienda,\n        qty,\n        user_id: user!.id,\n        source_import_line_id: selectedLine.id,\n      });\n      if (moveError) throw moveError;\n\n      await supabase.from('scan_events').insert({\n        pallet_id: pallet.id,\n        event_type: 'CONFIRM_QTY',\n        sku: selectedSku,\n        tienda: selectedLine.tienda,\n        qty,\n        user_id: user!.id,\n      });\n\n      showToast('success', 'Confirmado', `${qty} uds de ${selectedSku} → ${selectedLine.tienda}`);\n      await loadSkuProgress();\n\n      const currentStorePending = newConfirmed >= selectedLine.qty_to_send ? 0 : selectedLine.qty_to_send - newConfirmed;\n\n      if (manualStoreSelection && currentStorePending > 0) {\n        setSelectedLine({ ...selectedLine, qty_confirmed: newConfirmed, status: newStatus as any });\n        setQuantity('');\n        setError('');\n        setTimeout(() => qtyInputRef.current?.focus(), 100);\n        return;\n      }\n\n      const nextLine = await getNextPendingLine(selectedSku);\n      const { data: updatedInv } = await supabase\n        .from('pallet_inventory')\n        .select('*')\n        .eq('pallet_id', pallet.id)\n        .eq('sku', selectedSku)\n        .maybeSingle();\n\n      const hasInventory = updatedInv && updatedInv.qty_available > 0;\n\n      if (nextLine && hasInventory) {\n        const prevTienda = previousTiendaRef.current;\n        if (prevTienda && prevTienda !== nextLine.tienda) {\n          setTiendaChange({ prev: prevTienda, next: nextLine.tienda, sku: selectedSku });\n        }\n        previousTiendaRef.current = nextLine.tienda;\n        setSelectedLine(nextLine);\n        setSelectedStore(nextLine.tienda);\n        setManualStoreSelection(false);\n        setQuantity('');\n        setError('');\n        setTimeout(() => qtyInputRef.current?.focus(), 100);\n      } else {\n        setStep('scan');\n        setSelectedSku('');\n        setSelectedLine(null);\n        setSelectedStore('');\n        setManualStoreSelection(false);\n        setQuantity('');\n        setError('');\n        previousTiendaRef.current = null;\n\n        // Check remaining inventory after going back to scan\n        const remaining = await checkRemainingInventory();\n\n        if (!remaining || remaining.length === 0) {\n          showToast('info', 'Pallet agotado', 'Todo el inventario ha sido distribuido');\n          onComplete();\n        }\n      }\n    } catch (err) {\n      setError(`Error al confirmar: ${err instanceof Error ? err.message : 'Error desconocido'}`);\n    }\n  };\n\n  const handleOpenCloseModal = async () => {\n    if (!hasUser) { showToast('error', 'Error de sesión', 'Vuelve a iniciar sesión.'); return; }\n    const importId = resolvedImportId || pendingLines[0]?.import_id;\n    if (!importId) { showToast('error', 'Error', 'No se encontró el ID de importación'); return; }\n\n    const { data: openContainers } = await supabase\n      .from('containers')\n      .select('tienda')\n      .eq('import_id', importId)\n      .eq('status', 'OPEN');\n\n    if (!openContainers || openContainers.length === 0) {\n      showToast('warning', 'Sin contenedores', 'No hay contenedores abiertos para cerrar');\n      return;\n    }\n\n    const tiendas = [...new Set(openContainers.map((c) => c.tienda))];\n    setAvailableTiendas(tiendas);\n    if (tiendas.length === 1) setSelectedTiendaToClose(tiendas[0]);\n    setShowCloseModal(true);\n  };\n\n  const handleCerrarDistribucion = async () => {\n    if (!hasUser || !selectedTiendaToClose) return;\n    setClosingInProgress(true);\n\n    try {\n      const importId = resolvedImportId || pendingLines[0]?.import_id;\n      if (!importId) throw new Error('No se encontró el ID de importación');\n\n      const { data: openContainer } = await supabase\n        .from('containers')\n        .select('id, code')\n        .eq('import_id', importId)\n        .eq('tienda', selectedTiendaToClose)\n        .eq('status', 'OPEN')\n        .maybeSingle();\n\n      if (!openContainer) {\n        showToast('error', 'Sin contenedor', 'No hay contenedor abierto para esta tienda');\n        setShowCloseModal(false);\n        setSelectedTiendaToClose('');\n        return;\n      }\n\n      const { count } = await supabase\n        .from('container_lines')\n        .select('id', { count: 'exact' })\n        .eq('container_id', openContainer.id);\n\n      if (!count || count === 0) {\n        showToast('warning', 'Contenedor vacío', 'Confirma cantidades antes de cerrar');\n        setShowCloseModal(false);\n        setSelectedTiendaToClose('');\n        return;\n      }\n\n      const { error: updateError } = await supabase\n        .from('containers')\n        .update({ status: 'CLOSED', closed_at: new Date().toISOString() })\n        .eq('id', openContainer.id);\n      if (updateError) throw updateError;\n\n      await supabase.from('scan_events').insert({\n        pallet_id: pallet.id,\n        event_type: 'CLOSE',\n        tienda: selectedTiendaToClose,\n        notes: `Contenedor ${openContainer.code} cerrado con ${count} líneas`,\n        user_id: user!.id,\n      });\n\n      showToast('success', `Contenedor ${openContainer.code} cerrado`, `Tienda: ${selectedTiendaToClose} · ${count} líneas`, 6000);\n      setShowCloseModal(false);\n      setSelectedTiendaToClose('');\n      onComplete();\n    } catch (err) {\n      showToast('error', 'Error al cerrar', err instanceof Error ? err.message : 'Error desconocido');\n    } finally {\n      setClosingInProgress(false);\n    }\n  };\n\n  const loadAvailableTiendas = async () => {\n    const importId = resolvedImportId || pendingLines[0]?.import_id;\n    if (!importId) return;\n    const { data: openContainers } = await supabase\n      .from('containers')\n      .select('tienda')\n      .eq('import_id', importId)\n      .eq('status', 'OPEN');\n    if (openContainers) {\n      const tiendas = [...new Set(openContainers.map((c) => c.tienda))];\n      setAvailableTiendas(tiendas);\n      if (tiendas.length === 1) setSelectedTiendaToClose(tiendas[0]);\n    }\n  };\n\n  const currentPending = selectedLine ? selectedLine.qty_to_send - selectedLine.qty_confirmed : 0;\n  const isConfirmDisabled = !hasUser || !quantity || parseFloat(quantity) <= 0 || currentPending <= 0;\n\n  return (\n    <>\n      <div className=\"fixed inset-0 bg-black/50 flex items-end md:items-center justify-center z-50\">\n        <div className=\"bg-white w-full md:max-w-2xl md:rounded-xl shadow-xl flex flex-col max-h-[95vh] md:max-h-[90vh] rounded-t-2xl\">\n          {/* Header */}\n          <div className=\"flex items-center justify-between px-4 py-3 md:px-6 md:py-4 border-b border-gray-200 flex-shrink-0\">\n            <div>\n              <h2 className=\"text-base md:text-xl font-bold text-gray-900\">Distribución</h2>\n              <p className=\"text-xs text-gray-500 font-mono\">{pallet.pallet_code}</p>\n            </div>\n            <button onClick={onClose} className=\"w-9 h-9 flex items-center justify-center rounded-lg text-gray-400 hover:bg-gray-100 cursor-pointer\">\n              <i className=\"ri-close-line text-xl\"></i>\n            </button>\n          </div>\n\n          {/* Body */}\n          <div className=\"flex-1 overflow-y-auto p-4 md:p-6\">\n            {/* Session error */}\n            {!hasUser && (\n              <div className=\"bg-red-50 border border-red-200 rounded-lg p-3 mb-4 flex items-start gap-2\">\n                <i className=\"ri-error-warning-line text-red-500 text-lg mt-0.5 flex-shrink-0\"></i>\n                <p className=\"text-sm text-red-700\">\n                  {authLoading ? 'Cargando sesión...' : 'Sesión no disponible. Vuelve a iniciar sesión.'}\n                </p>\n              </div>\n            )}\n\n            {step === 'scan' ? (\n              /* ── SKU scan step ── */\n              <div className=\"flex flex-col items-center\">\n                <div className=\"w-16 h-16 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-2xl flex items-center justify-center mb-4\">\n                  <i className=\"ri-barcode-line text-3xl text-white\"></i>\n                </div>\n                <h3 className=\"text-lg font-bold text-gray-900 mb-1\">Leer SKU / Código de Barra</h3>\n                <p className=\"text-sm text-gray-500 mb-5 text-center\">\n                  Escanea el producto con el handheld o ingrésalo manualmente\n                </p>\n\n                {error && (\n                  <div className=\"w-full bg-red-50 border border-red-200 text-red-700 px-3 py-2.5 rounded-lg text-sm mb-4 flex items-center gap-2\">\n                    <i className=\"ri-error-warning-line flex-shrink-0\"></i>\n                    {error}\n                  </div>\n                )}\n\n                <form onSubmit={handleSkuSubmit} className=\"w-full space-y-3\">\n                  <div className=\"relative\">\n                    <div className=\"absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none\">\n                      <i className=\"ri-barcode-line text-gray-400 text-lg\"></i>\n                    </div>\n                    <input\n                      ref={skuInputRef}\n                      type=\"text\"\n                      value={skuInput}\n                      onChange={(e) => setSkuInput(e.target.value)}\n                      onKeyDown={(e) => { if (e.key === 'Enter') handleSkuSubmit(); }}\n                      placeholder=\"SKU o código de barra...\"\n                      autoComplete=\"off\"\n                      autoCorrect=\"off\"\n                      autoCapitalize=\"off\"\n                      spellCheck={false}\n                      className=\"w-full pl-10 pr-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-base font-mono tracking-wider text-gray-900 placeholder-gray-400\"\n                    />\n                  </div>\n                  <button\n                    type=\"submit\"\n                    disabled={!hasUser || !skuInput.trim()}\n                    className=\"w-full py-4 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-xl font-semibold text-base hover:from-teal-600 hover:to-cyan-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 cursor-pointer\"\n                  >\n                    <i className=\"ri-search-line text-lg\"></i>\n                    Buscar SKU\n                  </button>\n                </form>\n\n                {/* Surplus banner - shows when there's remaining inventory on scan step */}\n                {remainingInventory.length > 0 && (\n                  <div className=\"w-full mt-5 bg-amber-50 border border-amber-200 rounded-xl p-4\">\n                    <div className=\"flex items-start gap-2.5 mb-3\">\n                      <i className=\"ri-archive-2-line text-amber-600 text-lg flex-shrink-0 mt-0.5\"></i>\n                      <div>\n                        <p className=\"text-sm font-semibold text-amber-800\">Inventario restante en pallet</p>\n                        <p className=\"text-xs text-amber-700 mt-0.5\">\n                          Si ya terminaste la distribución y sobra mercadería, puedes reportarla como sobrante.\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"space-y-1.5 mb-3\">\n                      {remainingInventory.map((inv) => (\n                        <div key={inv.id} className=\"flex items-center justify-between bg-white/60 rounded-lg px-3 py-2\">\n                          <span className=\"text-xs font-mono font-semibold text-gray-700\">{inv.sku}</span>\n                          <span className=\"text-sm font-bold text-amber-600\">{inv.qty_available} uds</span>\n                        </div>\n                      ))}\n                    </div>\n                    <button\n                      onClick={() => setShowSobrante(true)}\n                      disabled={!hasUser}\n                      className=\"w-full py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-xl font-semibold text-sm hover:from-amber-600 hover:to-orange-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer flex items-center justify-center gap-2 whitespace-nowrap\"\n                    >\n                      <i className=\"ri-archive-2-line\"></i>\n                      Reportar Sobrante\n                    </button>\n                  </div>\n                )}\n\n                <p className=\"text-xs text-gray-400 mt-4 text-center\">\n                  <i className=\"ri-information-line mr-1\"></i>\n                  El handheld enviará el código automáticamente al presionar Enter\n                </p>\n              </div>\n            ) : (\n              /* ── Confirm step ── */\n              <div className=\"space-y-4\">\n                {/* SKU progress bar */}\n                {skuProgress && (\n                  <div className=\"bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-xl p-4\">\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <div>\n                        <h3 className=\"text-base font-bold text-gray-900 font-mono\">{selectedSku}</h3>\n                        <p className=\"text-xs text-gray-500\">Progreso total del SKU</p>\n                      </div>\n                      <div className=\"text-right\">\n                        <div className=\"text-2xl font-bold text-teal-600\">{skuProgress.percentage}%</div>\n                        <div className=\"text-xs text-gray-500\">{skuProgress.confirmed}/{skuProgress.total} uds</div>\n                      </div>\n                    </div>\n                    <div className=\"w-full bg-gray-200 rounded-full h-2.5 overflow-hidden\">\n                      <div\n                        className=\"bg-gradient-to-r from-teal-500 to-cyan-600 h-full rounded-full transition-all duration-500\"\n                        style={{ width: `${skuProgress.percentage}%` }}\n                      ></div>\n                    </div>\n                  </div>\n                )}\n\n                {/* Active store */}\n                <div className=\"bg-sky-50 border border-sky-200 rounded-xl p-4\">\n                  <div className=\"flex items-center justify-between mb-2 flex-wrap gap-2\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <span className=\"text-xs font-medium text-gray-500\">Tienda Activa:</span>\n                      <span className=\"text-base font-bold text-sky-700\">{selectedStore}</span>\n                      {selectedLine?.camion && (\n                        <span className=\"text-xs font-medium text-amber-600 bg-amber-100 px-2 py-0.5 rounded-full inline-flex items-center gap-1\">\n                          <i className=\"ri-truck-line\"></i>\n                          {selectedLine.camion}\n                        </span>\n                      )}\n                    </div>\n                    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${manualStoreSelection ? 'bg-amber-100 text-amber-700' : 'bg-teal-100 text-teal-700'}`}>\n                      {manualStoreSelection ? <><i className=\"ri-hand-coin-line mr-1\"></i>Manual</> : <><i className=\"ri-robot-line mr-1\"></i>Auto</>}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm text-gray-600\">Pendiente:</span>\n                    <span className={`text-xl font-bold ${currentPending > 0 ? 'text-amber-600' : 'text-emerald-600'}`}>\n                      {currentPending} uds\n                    </span>\n                  </div>\n                  {manualStoreSelection && (\n                    <button\n                      onClick={handleBackToAuto}\n                      className=\"mt-2 w-full px-3 py-2 bg-white border border-sky-200 text-sky-700 rounded-lg text-xs font-medium hover:bg-sky-50 transition-colors cursor-pointer flex items-center justify-center gap-1.5\"\n                    >\n                      <i className=\"ri-robot-line\"></i>\n                      Volver a modo automático\n                    </button>\n                  )}\n                </div>\n\n                {error && (\n                  <div className=\"bg-red-50 border border-red-200 text-red-700 px-3 py-2.5 rounded-lg text-sm flex items-center gap-2\">\n                    <i className=\"ri-error-warning-line flex-shrink-0\"></i>\n                    {error}\n                  </div>\n                )}\n\n                {currentPending <= 0 && (\n                  <div className=\"bg-emerald-50 border border-emerald-200 text-emerald-700 px-3 py-2.5 rounded-lg text-sm flex items-center gap-2\">\n                    <i className=\"ri-checkbox-circle-line flex-shrink-0\"></i>\n                    Esta tienda ya está completa\n                  </div>\n                )}\n\n                {/* Quantity input */}\n                <form onSubmit={handleConfirm}>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    Cantidad a confirmar\n                  </label>\n                  <div className=\"flex gap-2\">\n                    <input\n                      ref={qtyInputRef}\n                      type=\"number\"\n                      value={quantity}\n                      onChange={(e) => setQuantity(e.target.value)}\n                      onKeyDown={(e) => { if (e.key === 'Enter') handleConfirm(); }}\n                      className=\"flex-1 px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-2xl font-bold text-center text-gray-900\"\n                      placeholder=\"0\"\n                      min=\"0\"\n                      step=\"1\"\n                      inputMode=\"numeric\"\n                      disabled={currentPending <= 0 || !hasUser}\n                    />\n                  </div>\n                </form>\n\n                {/* Tiendas progress table */}\n                {tiendasProgress.length > 0 && (\n                  <div>\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <h4 className=\"text-xs font-semibold text-gray-500 uppercase tracking-wider\">Distribución por Tienda</h4>\n                      <p className=\"text-xs text-gray-400\">Toca para seleccionar</p>\n                    </div>\n                    <div className=\"border border-gray-200 rounded-xl overflow-hidden\">\n                      {tiendasProgress.map((tienda) => {\n                        const isActive = tienda.tienda === selectedStore;\n                        const isClickable = tienda.pending > 0;\n                        return (\n                          <div\n                            key={tienda.tienda}\n                            onClick={() => handleStoreClick(tienda)}\n                            className={`flex items-center justify-between px-3 py-3 border-b border-gray-100 last:border-b-0 transition-colors ${\n                              isActive ? 'bg-sky-50' : isClickable ? 'hover:bg-teal-50 cursor-pointer active:bg-teal-100' : 'opacity-50 cursor-not-allowed'\n                            }`}\n                          >\n                            <div className=\"flex items-center gap-2 min-w-0\">\n                              {isActive ? (\n                                <i className=\"ri-checkbox-circle-fill text-sky-500 text-lg flex-shrink-0\"></i>\n                              ) : isClickable ? (\n                                <i className=\"ri-radio-button-line text-gray-300 text-lg flex-shrink-0\"></i>\n                              ) : (\n                                <i className=\"ri-checkbox-circle-fill text-emerald-400 text-lg flex-shrink-0\"></i>\n                              )}\n                              <div className=\"min-w-0\">\n                                <div className=\"flex items-center gap-1.5 flex-wrap\">\n                                  <span className={`text-sm font-semibold truncate ${isActive ? 'text-sky-700' : 'text-gray-900'}`}>\n                                    {tienda.tienda}\n                                  </span>\n                                  {isActive && (\n                                    <span className=\"px-1.5 py-0.5 bg-sky-600 text-white text-[10px] font-bold rounded uppercase\">\n                                      Activa\n                                    </span>\n                                  )}\n                                </div>\n                                {tienda.camion && (\n                                  <span className=\"text-xs text-amber-600 flex items-center gap-0.5 mt-0.5\">\n                                    <i className=\"ri-truck-line\"></i>{tienda.camion}\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-3 flex-shrink-0 ml-2\">\n                              <div className=\"text-right\">\n                                <div className=\"text-xs text-gray-400\">{tienda.qty_confirmed}/{tienda.qty_to_send}</div>\n                                <div className={`text-sm font-bold ${tienda.pending > 0 ? 'text-amber-600' : 'text-emerald-600'}`}>\n                                  {tienda.pending > 0 ? `${tienda.pending} pend.` : 'Listo'}\n                                </div>\n                              </div>\n                              <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${\n                                tienda.status === 'DONE' ? 'bg-emerald-100 text-emerald-700' :\n                                tienda.status === 'PARTIAL' ? 'bg-amber-100 text-amber-700' :\n                                'bg-gray-100 text-gray-600'\n                              }`}>\n                                {tienda.status === 'DONE' ? 'Listo' : tienda.status === 'PARTIAL' ? 'Parcial' : 'Pend.'}\n                              </span>\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  </div>\n                )}\n\n                {/* Action buttons */}\n                <div className=\"flex gap-3 pt-2\">\n                  <button\n                    onClick={() => {\n                      setStep('scan');\n                      setSelectedSku('');\n                      setSelectedLine(null);\n                      setSelectedStore('');\n                      setManualStoreSelection(false);\n                      setQuantity('');\n                      setError('');\n                      previousTiendaRef.current = null;\n                    }}\n                    className=\"flex-1 py-3.5 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors cursor-pointer text-sm\"\n                  >\n                    Cancelar\n                  </button>\n                  <button\n                    onClick={handleConfirm}\n                    disabled={isConfirmDisabled}\n                    className=\"flex-1 py-3.5 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-xl font-semibold hover:from-teal-600 hover:to-cyan-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer text-sm\"\n                  >\n                    Confirmar\n                  </button>\n                </div>\n              </div>\n            )}\n          </div>\n\n          {/* Footer: close distribution */}\n          <div className=\"px-4 py-3 md:px-6 md:py-4 border-t border-gray-100 flex-shrink-0\">\n            <button\n              onClick={handleOpenCloseModal}\n              disabled={!hasUser}\n              className=\"w-full py-3.5 bg-gradient-to-r from-rose-500 to-rose-600 text-white rounded-xl font-semibold hover:from-rose-600 hover:to-rose-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer text-sm flex items-center justify-center gap-2\"\n            >\n              <i className=\"ri-inbox-line text-lg\"></i>\n              Cerrar Distribución\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Close distribution modal */}\n      {showCloseModal && (\n        <div className=\"fixed inset-0 bg-black/60 flex items-end md:items-center justify-center z-[60]\">\n          <div className=\"bg-white w-full md:max-w-md md:rounded-xl shadow-2xl rounded-t-2xl\">\n            <div className=\"flex items-center justify-between px-4 py-3 md:px-6 md:py-4 border-b border-gray-200\">\n              <h3 className=\"text-base md:text-lg font-bold text-gray-900\">Cerrar Distribución</h3>\n              <button\n                onClick={() => { setShowCloseModal(false); setSelectedTiendaToClose(''); }}\n                disabled={closingInProgress}\n                className=\"w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:bg-gray-100 cursor-pointer\"\n              >\n                <i className=\"ri-close-line text-xl\"></i>\n              </button>\n            </div>\n\n            <div className=\"p-4 md:p-6\">\n              <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4 flex items-start gap-2\">\n                <i className=\"ri-alert-line text-amber-600 text-lg flex-shrink-0 mt-0.5\"></i>\n                <p className=\"text-sm text-amber-700\">\n                  El contenedor cambiará a estado CLOSED y no se podrán agregar más líneas.\n                </p>\n              </div>\n\n              <div className=\"mb-4\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">Selecciona la tienda</label>\n                <select\n                  value={selectedTiendaToClose}\n                  onChange={(e) => setSelectedTiendaToClose(e.target.value)}\n                  onFocus={loadAvailableTiendas}\n                  className=\"w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-rose-500 focus:border-rose-500 text-sm cursor-pointer bg-white\"\n                  disabled={closingInProgress}\n                >\n                  <option value=\"\">-- Seleccionar tienda --</option>\n                  {availableTiendas.map((tienda) => (\n                    <option key={tienda} value={tienda}>{tienda}</option>\n                  ))}\n                </select>\n              </div>\n\n              <div className=\"flex gap-3\">\n                <button\n                  onClick={() => { setShowCloseModal(false); setSelectedTiendaToClose(''); }}\n                  disabled={closingInProgress}\n                  className=\"flex-1 py-3.5 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors cursor-pointer text-sm disabled:opacity-50\"\n                >\n                  Cancelar\n                </button>\n                <button\n                  onClick={handleCerrarDistribucion}\n                  disabled={!selectedTiendaToClose || closingInProgress}\n                  className=\"flex-1 py-3.5 bg-gradient-to-r from-rose-500 to-rose-600 text-white rounded-xl font-semibold hover:from-rose-600 hover:to-rose-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer text-sm flex items-center justify-center gap-2\"\n                >\n                  {closingInProgress ? (\n                    <><i className=\"ri-loader-4-line animate-spin\"></i>Cerrando...</>\n                  ) : (\n                    <><i className=\"ri-check-line\"></i>Confirmar Cierre</>\n                  )}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {tiendaChange && (\n        <TiendaChangePopup\n          previousTienda={tiendaChange.prev}\n          newTienda={tiendaChange.next}\n          sku={tiendaChange.sku}\n          onClose={() => setTiendaChange(null)}\n        />\n      )}\n\n      {/* Sobrante modal */}\n      {showSobrante && (\n        <SobranteModal\n          pallet={pallet}\n          importId={resolvedImportId}\n          onClose={() => {\n            setShowSobrante(false);\n            checkRemainingInventory();\n          }}\n          onComplete={() => {\n            setShowSobrante(false);\n            showToast('success', 'Sobrante procesado', 'El pallet ha sido liberado');\n            onComplete();\n          }}\n        />\n      )}\n    </>\n  );\n}\n","\nimport { useState, useRef, useEffect } from 'react';\nimport { Link } from 'react-router-dom';\nimport { supabase, Pallet, PalletInventory, ImportLine } from '../../lib/supabase';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useToast } from '../../components/base/Toast';\nimport DistribucionModal from './components/DistribucionModal';\n\nexport default function OperacionPage() {\n  const { user } = useAuth();\n  const { showToast } = useToast();\n  const [palletInput, setPalletInput] = useState('');\n  const [selectedPallet, setSelectedPallet] = useState<Pallet | null>(null);\n  const [palletInventory, setPalletInventory] = useState<PalletInventory[]>([]);\n  const [pendingLines, setPendingLines] = useState<ImportLine[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [showDistribucion, setShowDistribucion] = useState(false);\n  const palletInputRef = useRef<HTMLInputElement>(null);\n\n  // Auto-focus the pallet input on mount\n  useEffect(() => {\n    palletInputRef.current?.focus();\n  }, []);\n\n  // Re-focus after closing modal\n  useEffect(() => {\n    if (!showDistribucion && !selectedPallet) {\n      setTimeout(() => palletInputRef.current?.focus(), 100);\n    }\n  }, [showDistribucion, selectedPallet]);\n\n  const handlePalletSubmit = async (e?: React.FormEvent) => {\n    e?.preventDefault();\n    const code = palletInput.trim();\n    if (!code) return;\n\n    setLoading(true);\n    try {\n      const { data: pallet, error: palletError } = await supabase\n        .from('pallets')\n        .select('*')\n        .eq('pallet_code', code)\n        .maybeSingle();\n\n      if (palletError) throw palletError;\n\n      if (!pallet) {\n        showToast('error', 'Pallet no encontrado', 'El código no corresponde a ningún pallet registrado');\n        setPalletInput('');\n        palletInputRef.current?.focus();\n        return;\n      }\n\n      if (pallet.status === 'BLOCKED') {\n        showToast('warning', 'Pallet bloqueado', 'Este pallet está bloqueado y no puede ser utilizado');\n        setPalletInput('');\n        palletInputRef.current?.focus();\n        return;\n      }\n\n      if (pallet.locked_by && pallet.locked_by !== user?.id) {\n        showToast('warning', 'Pallet en uso', 'Este pallet está siendo usado por otro usuario');\n        setPalletInput('');\n        palletInputRef.current?.focus();\n        return;\n      }\n\n      await supabase\n        .from('pallets')\n        .update({ locked_by: user?.id, locked_at: new Date().toISOString() })\n        .eq('id', pallet.id);\n\n      await supabase.from('scan_events').insert({\n        pallet_id: pallet.id,\n        event_type: 'SCAN_PALLET',\n        raw_code: code,\n        user_id: user?.id,\n      });\n\n      const { data: inventory } = await supabase\n        .from('pallet_inventory')\n        .select('*')\n        .eq('pallet_id', pallet.id)\n        .gt('qty_available', 0);\n\n      const { data: lines } = await supabase\n        .from('import_lines')\n        .select('*')\n        .eq('pallet_code', pallet.pallet_code)\n        .in('status', ['PENDING', 'PARTIAL']);\n\n      setSelectedPallet(pallet);\n      setPalletInventory(inventory ?? []);\n      setPendingLines(lines ?? []);\n      setPalletInput('');\n    } catch (error: any) {\n      showToast('error', 'Error al leer pallet', 'No se pudo procesar el código');\n      setPalletInput('');\n      palletInputRef.current?.focus();\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleUnlock = async () => {\n    if (!selectedPallet) return;\n    try {\n      await supabase\n        .from('pallets')\n        .update({ locked_by: null, locked_at: null })\n        .eq('id', selectedPallet.id);\n\n      await supabase.from('scan_events').insert({\n        pallet_id: selectedPallet.id,\n        event_type: 'UNLOCK',\n        user_id: user?.id,\n      });\n\n      setSelectedPallet(null);\n      setPalletInventory([]);\n      setPendingLines([]);\n    } catch (error: any) {\n      showToast('error', 'Error', 'No se pudo liberar el pallet');\n    }\n  };\n\n  const refreshData = async () => {\n    if (!selectedPallet) return;\n    try {\n      const { data: inventory } = await supabase\n        .from('pallet_inventory')\n        .select('*')\n        .eq('pallet_id', selectedPallet.id)\n        .gt('qty_available', 0);\n\n      const { data: lines } = await supabase\n        .from('import_lines')\n        .select('*')\n        .eq('pallet_code', selectedPallet.pallet_code)\n        .in('status', ['PENDING', 'PARTIAL']);\n\n      setPalletInventory(inventory ?? []);\n      setPendingLines(lines ?? []);\n    } catch (error: any) {\n      showToast('error', 'Error', 'No se pudo actualizar la información del pallet');\n    }\n  };\n\n  return (\n    <div className=\"space-y-4 md:space-y-6 max-w-2xl mx-auto md:max-w-none\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between gap-3\">\n        <div>\n          <h2 className=\"text-lg md:text-2xl font-bold text-gray-900\">Operación</h2>\n          <p className=\"text-xs md:text-sm text-gray-500 mt-0.5\">Escanea pallets y distribuye productos</p>\n        </div>\n        <Link\n          to=\"/operacion/reportes\"\n          className=\"px-3 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg text-xs md:text-sm font-medium hover:bg-gray-50 transition-colors whitespace-nowrap cursor-pointer inline-flex items-center gap-1.5\"\n        >\n          <i className=\"ri-file-chart-line\"></i>\n          <span className=\"hidden sm:inline\">Ver Reportes</span>\n          <span className=\"sm:hidden\">Reportes</span>\n        </Link>\n      </div>\n\n      {!selectedPallet ? (\n        /* ── Pallet scan screen ── */\n        <div className=\"bg-white rounded-xl border border-gray-100 p-6 md:p-12\">\n          <div className=\"max-w-sm mx-auto text-center\">\n            <div className=\"w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-2xl flex items-center justify-center mx-auto mb-5\">\n              <i className=\"ri-qr-scan-2-line text-3xl md:text-4xl text-white\"></i>\n            </div>\n            <h2 className=\"text-lg md:text-xl font-bold text-gray-900 mb-2\">Leer Pallet</h2>\n            <p className=\"text-sm text-gray-500 mb-6\">\n              Escanea el código del pallet con el handheld o ingrésalo manualmente\n            </p>\n\n            <form onSubmit={handlePalletSubmit} className=\"space-y-3\">\n              <div className=\"relative\">\n                <div className=\"absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none\">\n                  <i className=\"ri-barcode-line text-gray-400 text-lg\"></i>\n                </div>\n                <input\n                  ref={palletInputRef}\n                  type=\"text\"\n                  value={palletInput}\n                  onChange={(e) => setPalletInput(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter') handlePalletSubmit();\n                  }}\n                  placeholder=\"Código de pallet...\"\n                  autoComplete=\"off\"\n                  autoCorrect=\"off\"\n                  autoCapitalize=\"off\"\n                  spellCheck={false}\n                  className=\"w-full pl-10 pr-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-base font-mono tracking-wider text-gray-900 placeholder-gray-400 transition-colors\"\n                />\n              </div>\n              <button\n                type=\"submit\"\n                disabled={loading || !palletInput.trim()}\n                className=\"w-full py-4 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-xl font-semibold text-base hover:from-teal-600 hover:to-cyan-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap cursor-pointer flex items-center justify-center gap-2\"\n              >\n                {loading ? (\n                  <>\n                    <i className=\"ri-loader-4-line animate-spin text-lg\"></i>\n                    Buscando...\n                  </>\n                ) : (\n                  <>\n                    <i className=\"ri-search-line text-lg\"></i>\n                    Buscar Pallet\n                  </>\n                )}\n              </button>\n            </form>\n\n            <p className=\"text-xs text-gray-400 mt-4\">\n              <i className=\"ri-information-line mr-1\"></i>\n              El handheld enviará el código automáticamente al presionar Enter\n            </p>\n          </div>\n        </div>\n      ) : (\n        /* ── Pallet loaded screen ── */\n        <div className=\"space-y-4\">\n          {/* Pallet info card */}\n          <div className=\"bg-white rounded-xl border border-gray-100 p-4 md:p-5\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-lg flex items-center justify-center\">\n                  <i className=\"ri-stack-line text-white text-lg\"></i>\n                </div>\n                <div>\n                  <h2 className=\"text-base md:text-lg font-bold text-gray-900\">{selectedPallet.pallet_code}</h2>\n                  <p className=\"text-xs text-gray-500\">Ubicación: {selectedPallet.ubicacion}</p>\n                </div>\n              </div>\n              <button\n                onClick={handleUnlock}\n                className=\"px-3 py-2 border border-gray-200 text-gray-600 rounded-lg text-xs md:text-sm font-medium hover:bg-gray-50 transition-colors whitespace-nowrap cursor-pointer flex items-center gap-1.5\"\n              >\n                <i className=\"ri-lock-unlock-line\"></i>\n                <span className=\"hidden sm:inline\">Liberar</span>\n              </button>\n            </div>\n\n            <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n              {/* Inventory */}\n              <div>\n                <h3 className=\"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2\">\n                  Inventario Disponible\n                </h3>\n                <div className=\"space-y-2\">\n                  {palletInventory.length === 0 ? (\n                    <p className=\"text-sm text-gray-400 py-2\">Sin inventario disponible</p>\n                  ) : (\n                    palletInventory.map((inv) => (\n                      <div key={inv.id} className=\"bg-gray-50 rounded-lg p-3 flex items-center justify-between\">\n                        <div>\n                          <span className=\"text-sm font-semibold text-gray-900 font-mono\">{inv.sku}</span>\n                          <p className=\"text-xs text-gray-400 mt-0.5\">Inicial: {inv.qty_initial}</p>\n                        </div>\n                        <span className=\"text-xl font-bold text-teal-600\">{inv.qty_available}</span>\n                      </div>\n                    ))\n                  )}\n                </div>\n              </div>\n\n              {/* Pending orders */}\n              <div>\n                <h3 className=\"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2\">\n                  Pedidos Pendientes\n                </h3>\n                <div className=\"space-y-2\">\n                  {pendingLines.length === 0 ? (\n                    <p className=\"text-sm text-gray-400 py-2\">Sin pedidos pendientes</p>\n                  ) : (\n                    pendingLines.map((line) => (\n                      <div key={line.id} className=\"bg-gray-50 rounded-lg p-3\">\n                        <div className=\"flex items-center justify-between mb-1\">\n                          <span className=\"text-sm font-semibold text-gray-900 font-mono\">{line.sku}</span>\n                          <div className=\"flex items-center gap-1.5 flex-wrap justify-end\">\n                            {line.camion && (\n                              <span className=\"text-xs font-medium text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full inline-flex items-center gap-1\">\n                                <i className=\"ri-truck-line\"></i>\n                                {line.camion}\n                              </span>\n                            )}\n                            <span className=\"text-xs font-medium text-teal-700 bg-teal-50 px-2 py-0.5 rounded-full\">\n                              {line.tienda}\n                            </span>\n                          </div>\n                        </div>\n                        <div className=\"text-xs text-gray-500\">\n                          Pendiente: <strong>{line.qty_to_send - line.qty_confirmed}</strong> / {line.qty_to_send}\n                        </div>\n                      </div>\n                    ))\n                  )}\n                </div>\n              </div>\n            </div>\n\n            <div className=\"mt-4 pt-4 border-t border-gray-100\">\n              <button\n                onClick={() => setShowDistribucion(true)}\n                disabled={palletInventory.length === 0 || pendingLines.length === 0}\n                className=\"w-full py-4 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-xl font-semibold text-base hover:from-teal-600 hover:to-cyan-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap cursor-pointer flex items-center justify-center gap-2\"\n              >\n                <i className=\"ri-box-3-line text-lg\"></i>\n                Iniciar Distribución\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {showDistribucion && selectedPallet && (\n        <DistribucionModal\n          pallet={selectedPallet}\n          inventory={palletInventory}\n          pendingLines={pendingLines}\n          onClose={() => {\n            setShowDistribucion(false);\n            refreshData();\n          }}\n          onComplete={() => {\n            setShowDistribucion(false);\n            handleUnlock();\n          }}\n        />\n      )}\n    </div>\n  );\n}\n"],"names":["generateContainerCode","lastContainer","supabase","nextNumber","getOrCreateOpenContainer","importId","tienda","userId","attempt","existingContainer","code","newContainer","insertError","error","resolve","isContainerEditable","containerId","container","TiendaChangePopup","previousTienda","newTienda","sku","onClose","isVisible","setIsVisible","useState","useEffect","handleClose","jsx","jsxs","e","SobranteModal","pallet","onComplete","user","useAuth","showToast","useToast","loading","setLoading","submitting","setSubmitting","entries","setEntries","containerCode","setContainerCode","step","setStep","loadRemainingInventory","inventory","items","inv","updateQty","index","value","qty","prev","entry","i","totalSobrante","sum","hasValidEntries","generateSurplusContainerCode","handleSubmit","containerError","lineError","currentInv","newAvailable","err","Fragment","DistribucionModal","pendingLines","authLoading","skuInput","setSkuInput","selectedSku","setSelectedSku","selectedLine","setSelectedLine","quantity","setQuantity","setError","showCloseModal","setShowCloseModal","showSobrante","setShowSobrante","remainingInventory","setRemainingInventory","resolvedImportId","setResolvedImportId","selectedTiendaToClose","setSelectedTiendaToClose","closingInProgress","setClosingInProgress","availableTiendas","setAvailableTiendas","selectedStore","setSelectedStore","manualStoreSelection","setManualStoreSelection","skuProgress","setSkuProgress","tiendasProgress","setTiendasProgress","skuLinesCache","setSkuLinesCache","tiendaChange","setTiendaChange","previousTiendaRef","useRef","skuInputRef","qtyInputRef","hasUser","loadSkuProgress","data","lines","total","l","confirmed","percentage","tiendas","line","getNextPendingLine","handleStoreClick","prevStore","handleBackToAuto","nextLine","handleSkuSubmit","resolvedSku","lineByBarcode","allLines","defaultLine","checkRemainingInventory","handleConfirm","pending","invError","newConfirmed","newStatus","containerLineError","moveError","currentStorePending","updatedInv","hasInventory","prevTienda","remaining","handleOpenCloseModal","openContainers","c","handleCerrarDistribucion","openContainer","count","updateError","loadAvailableTiendas","currentPending","isConfirmDisabled","isActive","isClickable","OperacionPage","palletInput","setPalletInput","selectedPallet","setSelectedPallet","palletInventory","setPalletInventory","setPendingLines","showDistribucion","setShowDistribucion","palletInputRef","handlePalletSubmit","palletError","handleUnlock","refreshData","Link"],"mappings":"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"}