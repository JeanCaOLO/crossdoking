import{s as a,r as i,j as e,u as ie,c as oe,L as ve}from"./index-DIAhV4tm.js";async function we(){const{data:u}=await a.from("containers").select("code").like("code","22O%").order("code",{ascending:!1}).limit(1).maybeSingle();let b=1;return u?.code&&(b=parseInt(u.code.substring(3),10)+1),`22O${b.toString().padStart(8,"0")}`}async function _e(o,u,b){let l=0;for(;l<3;)try{const{data:p}=await a.from("containers").select("id").eq("import_id",o).eq("tienda",u).eq("status","OPEN").maybeSingle();if(p)return p.id;const y=await we(),{data:d,error:v}=await a.from("containers").insert({code:y,import_id:o,tienda:u,status:"OPEN",created_by:b}).select("id").single();if(v){if(v.code==="23505"){l++;continue}throw v}return d.id}catch(p){if(l++,l>=3)throw new Error(`Error al crear contenedor despu√©s de 3 intentos: ${p}`);await new Promise(y=>setTimeout(y,100*l))}throw new Error("No se pudo crear el contenedor")}async function Se(o){const{data:u}=await a.from("containers").select("status").eq("id",o).maybeSingle();return u?.status==="OPEN"}function le({onScan:o,onClose:u}){const b=i.useRef(null),[N,l]=i.useState(""),[p,y]=i.useState("");i.useEffect(()=>(d(),()=>{v()}),[]);const d=async()=>{try{const w=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});b.current&&(b.current.srcObject=w)}catch(w){y("No se pudo acceder a la c√°mara"),console.error("Error accediendo a la c√°mara:",w)}},v=()=>{b.current&&b.current.srcObject&&b.current.srcObject.getTracks().forEach(C=>C.stop())},S=w=>{w.preventDefault(),N.trim()&&o(N.trim())};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-2xl w-full",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Escanear Pallet Padre"}),e.jsx("button",{onClick:u,className:"text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-2xl"})})]})}),e.jsxs("div",{className:"p-6",children:[p?e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm mb-6",children:p}):e.jsxs("div",{className:"mb-6",children:[e.jsx("video",{ref:b,autoPlay:!0,playsInline:!0,className:"w-full rounded-lg bg-black"}),e.jsx("p",{className:"text-center text-sm text-gray-600 mt-4",children:"Coloca el c√≥digo QR frente a la c√°mara"})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-6",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-4",children:"O ingresa el c√≥digo del pallet padre manualmente:"}),e.jsxs("form",{onSubmit:S,className:"flex items-center space-x-4",children:[e.jsx("input",{type:"text",value:N,onChange:w=>l(w.target.value),className:"flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm",placeholder:"C√≥digo del pallet o SKU"}),e.jsx("button",{type:"submit",className:"px-6 py-3 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-lg font-medium hover:from-teal-600 hover:to-cyan-700 transition-all whitespace-nowrap",children:"Confirmar"})]})]})]})]})})}function ke({previousTienda:o,newTienda:u,sku:b,onClose:N}){const[l,p]=i.useState(!1);i.useEffect(()=>{requestAnimationFrame(()=>p(!0))},[]);const y=()=>{p(!1),setTimeout(N,250)};return e.jsx("div",{className:`fixed inset-0 z-[70] flex items-center justify-center p-4 transition-all duration-250 ${l?"bg-black/40":"bg-black/0"}`,onClick:y,children:e.jsxs("div",{className:`bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden transition-all duration-250 ${l?"scale-100 opacity-100":"scale-95 opacity-0"}`,onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"bg-gradient-to-r from-sky-500 to-cyan-500 px-6 py-5 text-center",children:[e.jsx("div",{className:"w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-3",children:e.jsx("i",{className:"ri-store-2-line text-3xl text-white"})}),e.jsx("h3",{className:"text-lg font-bold text-white",children:"Cambio de Tienda"})]}),e.jsxs("div",{className:"px-6 py-5",children:[e.jsxs("p",{className:"text-sm text-gray-500 text-center mb-5",children:["El SKU ",e.jsx("span",{className:"font-semibold text-gray-800",children:b})," ahora se distribuye a otra tienda"]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-5",children:[e.jsxs("div",{className:"flex-1 text-center bg-gray-50 rounded-xl py-3 px-2 border border-gray-100",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wider text-gray-400 font-medium mb-1",children:"Anterior"}),e.jsx("p",{className:"text-sm font-bold text-gray-700",children:o})]}),e.jsx("div",{className:"w-8 h-8 flex items-center justify-center flex-shrink-0",children:e.jsx("i",{className:"ri-arrow-right-line text-xl text-sky-500"})}),e.jsxs("div",{className:"flex-1 text-center bg-sky-50 rounded-xl py-3 px-2 border border-sky-100",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wider text-sky-400 font-medium mb-1",children:"Nueva"}),e.jsx("p",{className:"text-sm font-bold text-sky-700",children:u})]})]}),e.jsx("button",{onClick:y,className:"w-full py-3 bg-gradient-to-r from-sky-500 to-cyan-500 text-white rounded-xl font-medium text-sm hover:from-sky-600 hover:to-cyan-600 transition-all whitespace-nowrap cursor-pointer",children:"Entendido"})]})]})})}function Ce({pallet:o,inventory:u,pendingLines:b,onClose:N,onComplete:l}){const{user:p,loading:y}=ie(),{showToast:d}=oe(),[v,S]=i.useState("scan"),[w,C]=i.useState(!1),[j,P]=i.useState(""),[c,_]=i.useState(null),[T,n]=i.useState(""),[h,x]=i.useState(""),[B,q]=i.useState(!1),[D,E]=i.useState(""),[R,H]=i.useState(!1),[de,Y]=i.useState([]),[G,L]=i.useState(""),[V,A]=i.useState(!1),[U,J]=i.useState(null),[W,X]=i.useState([]),[ce,Q]=i.useState([]),[z,Z]=i.useState(null),K=i.useRef(null),k=!y&&p!==null;i.useEffect(()=>{j&&v==="confirm"?ee():(J(null),X([]),Q([]))},[j,v]);const ee=async()=>{try{const{data:t}=await a.from("import_lines").select("*").eq("pallet_code",o.pallet_code).eq("sku",j).order("tienda",{ascending:!0});if(!t||t.length===0)return;Q(t);const s=t.reduce((f,g)=>f+g.qty_to_send,0),r=t.reduce((f,g)=>f+g.qty_confirmed,0),m=s>0?Math.round(r/s*100):0;J({total:s,confirmed:r,percentage:m});const I=t.map(f=>({tienda:f.tienda,camion:f.camion||"",qty_to_send:f.qty_to_send,qty_confirmed:f.qty_confirmed,pending:f.qty_to_send-f.qty_confirmed,status:f.status,importLineId:f.id}));X(I)}catch(t){console.error("Error cargando progreso del SKU:",t)}},te=async t=>{try{const{data:s}=await a.from("import_lines").select("*").eq("pallet_code",o.pallet_code).eq("sku",t).in("status",["PENDING","PARTIAL"]).order("tienda",{ascending:!0});return!s||s.length===0?null:s.find(m=>m.qty_confirmed<m.qty_to_send)||null}catch(s){return console.error("Error buscando siguiente l√≠nea:",s),null}},me=t=>{if(t.pending<=0){d("warning","Tienda completa",`${t.tienda} ya tiene todas las unidades confirmadas`);return}const s=ce.find(m=>m.tienda===t.tienda);if(!s)return;const r=G;L(t.tienda),_(s),A(!0),n(""),x(""),r&&r!==t.tienda&&d("info","Tienda cambiada",`Ahora distribuyendo a ${t.tienda}`)},xe=async()=>{A(!1);const t=await te(j);t&&(_(t),L(t.tienda),n(""),x(""),d("info","Modo autom√°tico",`Tienda activa: ${t.tienda}`))},ue=async t=>{C(!1),x("");let s=t,r=u.find(g=>g.sku===t);if(!r){const{data:g}=await a.from("import_lines").select("sku").eq("barcode",t).eq("pallet_code",o.pallet_code).limit(1).maybeSingle();g&&(s=g.sku,r=u.find(F=>F.sku===s))}if(!r){x("SKU/C√≥digo de barra no encontrado en este pallet");return}const{data:m}=await a.from("pallet_inventory").select("*").eq("id",r.id).maybeSingle();if(!m||m.qty_available<=0){x("No hay cantidad disponible para este SKU en el pallet");return}const{data:I}=await a.from("import_lines").select("*").eq("pallet_code",o.pallet_code).eq("sku",s).in("status",["PENDING","PARTIAL"]).order("tienda",{ascending:!0});if(!I||I.length===0){x("No hay pedidos pendientes para este SKU");return}const f=I.find(g=>g.qty_confirmed<g.qty_to_send);if(!f){x("No hay pedidos pendientes para este SKU");return}Q(I),k&&await a.from("scan_events").insert({pallet_id:o.id,event_type:"SCAN_SKU",raw_code:t,sku:s,tienda:f.tienda,user_id:p.id}),K.current=f.tienda,P(s),_(f),L(f.tienda),A(!1),S("confirm")},pe=async()=>{if(console.log("üîµ handleConfirm iniciado"),!k){console.log("‚ùå Usuario no disponible"),x("Sesi√≥n no cargada. Por favor, vuelve a iniciar sesi√≥n."),d("error","Error de sesi√≥n","Tu sesi√≥n no est√° cargada correctamente. Vuelve a iniciar sesi√≥n.");return}if(!c||!T){console.log("‚ùå Validaci√≥n inicial fallida");return}const t=parseFloat(T);if(t<=0){x("La cantidad debe ser mayor a 0");return}const s=c.qty_to_send-c.qty_confirmed;if(s<=0){x("Esta l√≠nea ya est√° completa");return}const{data:r}=await a.from("pallet_inventory").select("*").eq("pallet_id",o.id).eq("sku",j).maybeSingle();if(!r||t>r.qty_available){x("Cantidad mayor al disponible en pallet");return}if(t>s){x("Cantidad mayor al pendiente del pedido");return}try{const m=await _e(c.import_id,c.tienda,p.id);if(!await Se(m)){x("El contenedor de esta tienda ya est√° cerrado");return}const{error:f}=await a.from("pallet_inventory").update({qty_available:r.qty_available-t}).eq("id",r.id);if(f)throw f;const g=c.qty_confirmed+t,F=g>=c.qty_to_send?"DONE":"PARTIAL",{error:se}=await a.from("import_lines").update({qty_confirmed:g,status:F,...F==="DONE"?{done_at:new Date().toISOString(),done_by:p.id}:{}}).eq("id",c.id);if(se)throw se;const{error:re}=await a.from("container_lines").insert({container_id:m,pallet_id:o.id,sku:j,qty:t,source_import_line_id:c.id});if(re)throw re;const{error:ae}=await a.from("distribution_moves").insert({import_id:c.import_id,pallet_id:o.id,sku:j,tienda:c.tienda,qty:t,user_id:p.id,source_import_line_id:c.id});if(ae)throw ae;await a.from("scan_events").insert({pallet_id:o.id,event_type:"CONFIRM_QTY",sku:j,tienda:c.tienda,qty:t,user_id:p.id}),d("success","Cantidad confirmada",`${t} uds de ${j} ‚Üí ${c.tienda}`),await ee();const je=g>=c.qty_to_send?0:c.qty_to_send-g;if(V&&je>0){_({...c,qty_confirmed:g,status:F}),n(""),x("");return}const O=await te(j),{data:ne}=await a.from("pallet_inventory").select("*").eq("pallet_id",o.id).eq("sku",j).maybeSingle(),Ne=ne&&ne.qty_available>0;if(O&&Ne){const $=K.current;$&&$!==O.tienda&&Z({prev:$,next:O.tienda,sku:j}),K.current=O.tienda,_(O),L(O.tienda),A(!1),n(""),x("")}else{S("scan"),P(""),_(null),L(""),A(!1),n(""),x(""),K.current=null;const{data:$}=await a.from("pallet_inventory").select("*").eq("pallet_id",o.id).gt("qty_available",0);(!$||$.length===0)&&(d("info","Pallet agotado","Todo el inventario de este pallet ha sido distribuido"),l())}}catch(m){console.error("‚ùå Error en handleConfirm:",m),x(`Error al confirmar cantidad: ${m instanceof Error?m.message:"Error desconocido"}`)}},fe=async()=>{if(!k){d("error","Error de sesi√≥n","Tu sesi√≥n no est√° cargada. Vuelve a iniciar sesi√≥n.");return}const t=b[0]?.import_id;if(!t){d("error","Error","No se encontr√≥ el ID de importaci√≥n");return}const{data:s}=await a.from("containers").select("tienda").eq("import_id",t).eq("status","OPEN");if(!s||s.length===0){d("warning","Sin contenedores","No hay contenedores abiertos para cerrar");return}const r=[...new Set(s.map(m=>m.tienda))];Y(r),r.length===1&&E(r[0]),q(!0)},be=async()=>{if(!k){d("error","Error de sesi√≥n","Tu sesi√≥n no est√° cargada. Vuelve a iniciar sesi√≥n.");return}if(!D){x("Debes seleccionar una tienda");return}H(!0);try{const t=b[0]?.import_id;if(!t)throw new Error("No se encontr√≥ el ID de importaci√≥n");const{data:s}=await a.from("containers").select("id, code").eq("import_id",t).eq("tienda",D).eq("status","OPEN").maybeSingle();if(!s){d("error","Sin contenedor","No hay contenedor abierto para esta tienda"),q(!1),E("");return}const{count:r}=await a.from("container_lines").select("id",{count:"exact"}).eq("container_id",s.id);if(!r||r===0){d("warning","Contenedor vac√≠o","Confirma cantidades antes de cerrar el contenedor"),q(!1),E("");return}const{error:m}=await a.from("containers").update({status:"CLOSED",closed_at:new Date().toISOString()}).eq("id",s.id);if(m)throw m;await a.from("scan_events").insert({pallet_id:o.id,event_type:"CLOSE",tienda:D,notes:`Contenedor ${s.code} cerrado con ${r} l√≠neas`,user_id:p.id}),d("success",`Contenedor ${s.code} cerrado`,`Tienda: ${D} ¬∑ ${r} l√≠neas registradas`,6e3),q(!1),E(""),l()}catch(t){console.error("Error cerrando distribuci√≥n:",t),d("error","Error al cerrar",t instanceof Error?t.message:"Error desconocido")}finally{H(!1)}},he=async()=>{const t=b[0]?.import_id;if(!t)return;const{data:s}=await a.from("containers").select("tienda").eq("import_id",t).eq("status","OPEN");if(s){const r=[...new Set(s.map(m=>m.tienda))];Y(r),r.length===1&&E(r[0])}},M=c?c.qty_to_send-c.qty_confirmed:0,ge=!k||!T||parseFloat(T)<=0||M<=0,ye=!k;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900",children:["Distribuci√≥n - ",o.pallet_code]}),e.jsx("button",{onClick:N,className:"text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-2xl"})})]})}),e.jsxs("div",{className:"p-6",children:[!k&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-error-warning-line text-red-600 text-xl mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-900 mb-1",children:"Sesi√≥n no cargada"}),e.jsx("p",{className:"text-sm text-red-700",children:y?"Cargando tu sesi√≥n...":"Tu sesi√≥n no est√° disponible. Por favor, vuelve a iniciar sesi√≥n para continuar."})]})]})}),v==="scan"?e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-2xl flex items-center justify-center mx-auto mb-6",children:e.jsx("i",{className:"ri-barcode-line text-4xl text-white"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Escanear SKU / C√≥digo de Barra"}),e.jsx("p",{className:"text-gray-600 mb-8",children:"Escanea el c√≥digo del producto o su c√≥digo de barras"}),h&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm mb-6",children:h}),e.jsxs("button",{onClick:()=>C(!0),disabled:!k,className:"px-8 py-4 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-lg font-medium hover:from-teal-600 hover:to-cyan-700 transition-all whitespace-nowrap cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx("i",{className:"ri-camera-line mr-2"}),"Escanear SKU / C√≥digo de Barra"]})]}):e.jsxs("div",{children:[U&&e.jsxs("div",{className:"bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-xl p-5 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:j}),e.jsx("p",{className:"text-sm text-gray-600",children:"Progreso total del SKU"})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-3xl font-bold text-teal-600",children:[U.percentage,"%"]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[U.confirmed," / ",U.total," uds"]})]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3 overflow-hidden",children:e.jsx("div",{className:"bg-gradient-to-r from-teal-500 to-cyan-600 h-full rounded-full transition-all duration-500",style:{width:`${U.percentage}%`}})})]}),e.jsxs("div",{className:"bg-sky-50 border border-sky-200 rounded-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Tienda Activa:"}),e.jsx("span",{className:"text-lg font-bold text-sky-600",children:G}),c?.camion&&e.jsxs("span",{className:"text-xs font-medium text-amber-600 bg-amber-100 px-2 py-1 rounded-full inline-flex items-center",children:[e.jsx("i",{className:"ri-truck-line mr-1"}),c.camion]})]}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ${V?"bg-amber-100 text-amber-700":"bg-teal-100 text-teal-700"}`,children:V?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-hand-coin-line mr-1"}),"Manual"]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-robot-line mr-1"}),"Autom√°tica"]})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Pendiente:"}),e.jsxs("span",{className:`text-lg font-bold ${M>0?"text-amber-600":"text-emerald-600"}`,children:[M," uds"]})]}),V&&e.jsxs("button",{onClick:xe,className:"mt-3 w-full px-3 py-2 bg-white border border-sky-200 text-sky-700 rounded-lg text-xs font-medium hover:bg-sky-50 transition-colors whitespace-nowrap cursor-pointer flex items-center justify-center gap-1.5",children:[e.jsx("i",{className:"ri-robot-line"}),"Volver a modo autom√°tico"]})]}),h&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm mb-6",children:h}),M<=0&&e.jsxs("div",{className:"bg-emerald-50 border border-emerald-200 text-emerald-700 px-4 py-3 rounded-lg text-sm mb-6",children:[e.jsx("i",{className:"ri-checkbox-circle-line mr-2"}),"Esta tienda ya est√° completa"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cantidad a confirmar"}),e.jsx("input",{type:"number",value:T,onChange:t=>n(t.target.value),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent text-lg",placeholder:"0",min:"0",step:"0.01",disabled:M<=0||!k})]}),W.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Distribuci√≥n por Tienda"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Haz clic en una tienda para seleccionarla"})]}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-semibold text-gray-700",children:"Tienda"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold text-gray-700",children:"Cami√≥n"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700",children:"Requerido"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700",children:"Confirmado"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700",children:"Pendiente"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700",children:"Estado"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:W.map(t=>{const s=t.tienda===G,r=t.pending>0;return e.jsxs("tr",{onClick:()=>me(t),className:`transition-colors ${s?"bg-sky-50 ring-2 ring-inset ring-sky-400":r?"bg-white hover:bg-teal-50 cursor-pointer":"bg-gray-50/50 opacity-60 cursor-not-allowed"}`,title:s?"Tienda activa":r?`Seleccionar ${t.tienda}`:"Tienda ya completa",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center",children:[s?e.jsx("i",{className:"ri-checkbox-circle-fill text-sky-600 mr-2 text-base"}):r?e.jsx("i",{className:"ri-radio-button-line text-gray-300 mr-2 text-base"}):e.jsx("i",{className:"ri-checkbox-circle-fill text-emerald-400 mr-2 text-base"}),e.jsx("span",{className:`font-medium ${s?"text-sky-700":"text-gray-900"}`,children:t.tienda}),s&&e.jsx("span",{className:"ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-sky-600 text-white uppercase tracking-wide",children:"Activa"})]})}),e.jsx("td",{className:"px-4 py-3",children:t.camion?e.jsxs("span",{className:"inline-flex items-center text-xs font-medium text-amber-700",children:[e.jsx("i",{className:"ri-truck-line mr-1"}),t.camion]}):e.jsx("span",{className:"text-xs text-gray-400",children:"‚Äî"})}),e.jsx("td",{className:"px-4 py-3 text-center text-gray-700",children:t.qty_to_send}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:"font-semibold text-teal-600",children:t.qty_confirmed})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:`font-semibold ${t.pending>0?"text-amber-600":"text-emerald-600"}`,children:t.pending})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsxs("span",{className:`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${t.status==="DONE"?"bg-emerald-100 text-emerald-700":t.status==="PARTIAL"?"bg-amber-100 text-amber-700":"bg-gray-100 text-gray-700"}`,children:[t.status==="DONE"&&e.jsx("i",{className:"ri-checkbox-circle-fill mr-1"}),t.status==="PARTIAL"&&e.jsx("i",{className:"ri-time-line mr-1"}),t.status==="PENDING"&&e.jsx("i",{className:"ri-hourglass-line mr-1"}),t.status]})})]},t.tienda)})})]})})})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:()=>{S("scan"),P(""),_(null),L(""),A(!1),n(""),x(""),K.current=null},className:"flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors whitespace-nowrap cursor-pointer",children:"Cancelar"}),e.jsx("button",{onClick:pe,disabled:ge,className:"flex-1 px-6 py-3 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-lg font-medium hover:from-teal-600 hover:to-cyan-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap cursor-pointer",children:"Confirmar"})]})]}),e.jsx("div",{className:"mt-8 pt-6 border-t border-gray-200",children:e.jsxs("button",{onClick:fe,disabled:ye,className:"w-full px-6 py-3 bg-gradient-to-r from-rose-500 to-rose-600 text-white rounded-lg font-medium hover:from-rose-600 hover:to-rose-700 transition-all whitespace-nowrap cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx("i",{className:"ri-inbox-line mr-2"}),"Cerrar Distribuci√≥n (Generar Licencia)"]})})]})]}),w&&e.jsx(le,{onScan:ue,onClose:()=>C(!1)})]}),B&&e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Cerrar Distribuci√≥n"}),e.jsx("button",{onClick:()=>{q(!1),E("")},className:"text-gray-400 hover:text-gray-600 cursor-pointer",disabled:R,children:e.jsx("i",{className:"ri-close-line text-2xl"})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-alert-line text-amber-600 text-xl mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-amber-900 mb-1",children:"Importante"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Al cerrar la distribuci√≥n, el contenedor cambiar√° a estado CLOSED y no se podr√°n agregar m√°s l√≠neas."})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Selecciona la tienda"}),e.jsxs("select",{value:D,onChange:t=>E(t.target.value),onFocus:he,className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent text-sm cursor-pointer",disabled:R,children:[e.jsx("option",{value:"",children:"-- Seleccionar tienda --"}),de.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:()=>{q(!1),E("")},disabled:R,className:"flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors whitespace-nowrap cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancelar"}),e.jsx("button",{onClick:be,disabled:!D||R,className:"flex-1 px-6 py-3 bg-gradient-to-r from-rose-500 to-rose-600 text-white rounded-lg font-medium hover:from-rose-600 hover:to-rose-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap cursor-pointer",children:R?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line mr-2 animate-spin"}),"Cerrando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-check-line mr-2"}),"Confirmar Cierre"]})})]})]})]})}),z&&e.jsx(ke,{previousTienda:z.prev,newTienda:z.next,sku:z.sku,onClose:()=>Z(null)})]})}function Ee(){const{user:o}=ie(),{showToast:u}=oe(),[b,N]=i.useState(!1),[l,p]=i.useState(null),[y,d]=i.useState([]),[v,S]=i.useState([]),[w,C]=i.useState(!1),[j,P]=i.useState(!1),c=async n=>{C(!0),N(!1);try{const{data:h,error:x}=await a.from("pallets").select("*").eq("pallet_code",n).maybeSingle();if(x)throw x;if(!h){u("error","Pallet no encontrado","El c√≥digo escaneado no corresponde a ning√∫n pallet registrado");return}if(h.status==="BLOCKED"){u("warning","Pallet bloqueado","Este pallet est√° bloqueado y no puede ser utilizado");return}if(h.locked_by&&h.locked_by!==o?.id){u("warning","Pallet en uso","Este pallet est√° siendo usado por otro usuario");return}await a.from("pallets").update({locked_by:o?.id,locked_at:new Date().toISOString()}).eq("id",h.id),await a.from("scan_events").insert({pallet_id:h.id,event_type:"SCAN_PALLET",raw_code:n,user_id:o?.id});const{data:B}=await a.from("pallet_inventory").select("*").eq("pallet_id",h.id).gt("qty_available",0),{data:q}=await a.from("import_lines").select("*").eq("pallet_code",h.pallet_code).in("status",["PENDING","PARTIAL"]);p(h),d(B??[]),S(q??[])}catch(h){console.error("Error escaneando pallet:",h),u("error","Error al escanear","No se pudo procesar el c√≥digo escaneado")}finally{C(!1)}},_=async()=>{if(l)try{await a.from("pallets").update({locked_by:null,locked_at:null}).eq("id",l.id),await a.from("scan_events").insert({pallet_id:l.id,event_type:"UNLOCK",user_id:o?.id}),p(null),d([]),S([])}catch(n){console.error("Error desbloqueando pallet:",n),u("error","Error","No se pudo liberar el pallet")}},T=async()=>{if(l)try{const{data:n}=await a.from("pallet_inventory").select("*").eq("pallet_id",l.id).gt("qty_available",0),{data:h}=await a.from("import_lines").select("*").eq("pallet_code",l.pallet_code).in("status",["PENDING","PARTIAL"]);d(n??[]),S(h??[])}catch(n){console.error("Error refrescando datos del pallet:",n),u("error","Error","No se pudo actualizar la informaci√≥n del pallet")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Operaci√≥n de Distribuci√≥n"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Escanea pallets y distribuye productos a tiendas"})]}),e.jsxs(ve,{to:"/operacion/reportes",className:"px-4 py-2.5 bg-white border border-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors whitespace-nowrap cursor-pointer inline-flex items-center",children:[e.jsx("i",{className:"ri-file-chart-line mr-2"}),"Ver Reportes"]})]}),l?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:l.pallet_code}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Ubicaci√≥n: ",l.ubicacion]})]}),e.jsxs("button",{onClick:_,className:"px-4 py-2 border border-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-lock-unlock-line mr-2"}),"Liberar Pallet"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Inventario Disponible"}),e.jsx("div",{className:"space-y-2",children:y.map(n=>e.jsxs("div",{className:"border border-gray-100 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:n.sku}),e.jsx("span",{className:"text-base font-bold text-teal-600",children:n.qty_available})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5",children:["Inicial: ",n.qty_initial]})]},n.id))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Pedidos Pendientes"}),e.jsx("div",{className:"space-y-2",children:v.map(n=>e.jsxs("div",{className:"border border-gray-100 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:n.sku}),e.jsxs("div",{className:"flex items-center gap-2",children:[n.camion&&e.jsxs("span",{className:"text-xs font-medium text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full inline-flex items-center",children:[e.jsx("i",{className:"ri-truck-line mr-1"}),n.camion]}),e.jsx("span",{className:"text-xs font-medium text-sky-600 bg-sky-50 px-2 py-0.5 rounded-full",children:n.tienda})]})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Pendiente: ",n.qty_to_send-n.qty_confirmed," / ",n.qty_to_send]})]},n.id))})]})]}),e.jsx("div",{className:"mt-6 pt-5 border-t border-gray-100",children:e.jsxs("button",{onClick:()=>P(!0),disabled:y.length===0||v.length===0,className:"w-full px-6 py-3.5 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-lg font-medium hover:from-teal-600 hover:to-cyan-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-sm whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-box-3-line mr-2"}),"Iniciar Distribuci√≥n"]})})]})}):e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-12 text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-2xl flex items-center justify-center mx-auto mb-6",children:e.jsx("i",{className:"ri-qr-scan-2-line text-4xl text-white"})}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-3",children:"Escanear Pallet"}),e.jsx("p",{className:"text-sm text-gray-500 mb-8",children:"Escanea el c√≥digo QR del pallet para iniciar la distribuci√≥n"}),e.jsxs("button",{onClick:()=>N(!0),className:"px-8 py-3.5 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-lg font-medium hover:from-teal-600 hover:to-cyan-700 transition-all text-sm whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-camera-line mr-2"}),"Activar C√°mara"]})]}),b&&e.jsx(le,{onScan:c,onClose:()=>N(!1)}),j&&l&&e.jsx(Ce,{pallet:l,inventory:y,pendingLines:v,onClose:()=>{P(!1),T()},onComplete:()=>{P(!1),_()}})]})}export{Ee as default};
//# sourceMappingURL=page-BDW6-zD3.js.map
