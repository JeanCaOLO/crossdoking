import{j as e,L,u as R,c as P,r as c,s as x,b as A}from"./index-CbDMZEJu.js";const I={OPEN:{bg:"bg-sky-100 text-sky-700",label:"Abierto"},CLOSED:{bg:"bg-amber-100 text-amber-700",label:"Cerrado"},DISPATCHED:{bg:"bg-emerald-100 text-emerald-700",label:"Despachado"}};function C(d){const i=new Date(d);return Number.isNaN(i.getTime())?"Fecha no válida":i.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}function T({code:d,tienda:i,camion:o,status:n,createdAt:t,closedAt:m,createdByEmail:u}){const s=I[n]??{bg:"bg-gray-100 text-gray-700",label:n};return e.jsxs("div",{children:[e.jsxs(L,{to:"/contenedores",className:"text-teal-600 hover:text-teal-700 text-sm font-medium mb-3 inline-flex items-center cursor-pointer",children:[e.jsx("i",{className:"ri-arrow-left-line mr-1"}),"Volver a Contenedores"]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-4 md:p-5 mt-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-rose-500 to-rose-600 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx("i",{className:"ri-inbox-line text-xl md:text-2xl text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold text-gray-900 font-mono",children:d}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5 flex-wrap",children:[e.jsx("span",{className:"text-sm text-gray-600 font-medium",children:i}),o&&e.jsxs("span",{className:"inline-flex items-center gap-1 text-xs text-amber-600 font-medium",children:[e.jsx("i",{className:"ri-truck-line"}),o]})]})]})]}),e.jsx("span",{className:`px-3 py-1.5 rounded-full text-xs font-semibold ${s.bg}`,children:s.label})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mt-4 pt-4 border-t border-gray-100",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wider text-gray-400 font-medium",children:"Creado"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-800 mt-1",children:C(t)})]}),m&&e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wider text-gray-400 font-medium",children:"Cerrado"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-800 mt-1",children:C(m)})]}),u&&e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wider text-gray-400 font-medium",children:"Creado por"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-800 mt-1",children:u})]})]})]})]})}function M({totalPallets:d,totalSkus:i,totalUnits:o}){const n=[{label:"Pallets",value:d,icon:"ri-stack-line",gradient:"from-teal-500 to-cyan-600"},{label:"SKUs distintos",value:i,icon:"ri-barcode-line",gradient:"from-violet-500 to-purple-600"},{label:"Unidades totales",value:o.toLocaleString("es-ES"),icon:"ri-hashtag",gradient:"from-rose-500 to-pink-600"}];return e.jsx("div",{className:"grid grid-cols-3 gap-3 md:gap-4",children:n.map(t=>e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3 md:p-5 flex flex-col md:flex-row items-center md:items-center gap-2 md:gap-4",children:[e.jsx("div",{className:`w-9 h-9 md:w-11 md:h-11 bg-gradient-to-br ${t.gradient} rounded-lg flex items-center justify-center flex-shrink-0`,children:e.jsx("i",{className:`${t.icon} text-base md:text-xl text-white`})}),e.jsxs("div",{className:"text-center md:text-left",children:[e.jsx("p",{className:"text-xl md:text-2xl font-bold text-gray-900",children:t.value}),e.jsx("p",{className:"text-[10px] md:text-xs text-gray-500 mt-0.5 leading-tight",children:t.label})]})]},t.label))})}function $({rows:d,containerStatus:i,onReverse:o}){const n=i!=="DISPATCHED";return d.length===0?e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-10 text-center",children:[e.jsx("div",{className:"w-14 h-14 bg-gray-50 rounded-2xl flex items-center justify-center mx-auto mb-3",children:e.jsx("i",{className:"ri-inbox-line text-3xl text-gray-300"})}),e.jsx("p",{className:"text-sm text-gray-500",children:"No hay líneas en este contenedor"})]}):e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 overflow-hidden",children:[e.jsxs("div",{className:"px-4 py-3 md:px-6 md:py-4 border-b border-gray-100",children:[e.jsx("h3",{className:"text-base md:text-lg font-bold text-gray-900",children:"Contenido del Contenedor"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[d.length," líneas registradas"]})]}),e.jsx("div",{className:"md:hidden divide-y divide-gray-100",children:d.map(t=>e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx("i",{className:"ri-stack-line text-white text-sm"})}),e.jsx("span",{className:"text-sm font-bold text-gray-900 font-mono truncate",children:t.pallet_code})]}),e.jsx("span",{className:"text-xl font-bold text-teal-600 flex-shrink-0",children:t.qty})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-md text-xs font-semibold bg-sky-100 text-sky-700 font-mono",children:t.sku}),t.ubicacion&&e.jsxs("span",{className:"text-xs text-gray-500",children:[e.jsx("i",{className:"ri-map-pin-line mr-0.5"}),t.ubicacion]})]}),t.descripcion&&e.jsx("p",{className:"text-xs text-gray-600 leading-snug",children:t.descripcion}),t.barcode&&e.jsx("p",{className:"text-xs text-gray-400 font-mono",children:t.barcode}),n&&e.jsxs("button",{onClick:()=>o?.(t.id),className:"w-full mt-1 py-2.5 bg-amber-50 text-amber-700 rounded-lg text-xs font-semibold hover:bg-amber-100 active:bg-amber-200 transition-colors cursor-pointer flex items-center justify-center gap-1.5",children:[e.jsx("i",{className:"ri-arrow-go-back-line"}),"Reversar línea"]})]},t.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Pallet"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Ubicación"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"SKU"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Descripción"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Código de Barra"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Cantidad"}),n&&e.jsx("th",{className:"px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:d.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-stack-line text-white text-sm"})}),e.jsx("span",{className:"text-sm font-semibold text-gray-900 font-mono",children:t.pallet_code})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.ubicacion||"—"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold bg-sky-100 text-sky-700 font-mono",children:t.sku})}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-700",children:t.descripcion||"—"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono",children:t.barcode||"—"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:e.jsx("span",{className:"text-sm font-bold text-teal-600",children:t.qty})}),n&&e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:e.jsxs("button",{onClick:()=>o?.(t.id),className:"inline-flex items-center px-3 py-1.5 bg-amber-50 text-amber-700 rounded-lg text-xs font-semibold hover:bg-amber-100 transition-colors cursor-pointer gap-1.5",children:[e.jsx("i",{className:"ri-arrow-go-back-line"}),"Reversar"]})})]},t.id))})]})})]})}function U({lineId:d,onClose:i,onSuccess:o}){const{user:n}=R(),{showToast:t}=P(),[m,u]=c.useState(!1),[s,S]=c.useState(null),[v,b]=c.useState("");c.useEffect(()=>{_()},[d]);const _=async()=>{try{const{data:r,error:p}=await x.from("container_lines").select(`
          id,
          container_id,
          pallet_id,
          sku,
          qty,
          source_import_line_id,
          pallets(pallet_code),
          import_lines:source_import_line_id(descripcion, tienda)
        `).eq("id",d).maybeSingle();if(p)throw p;if(!r){b("Línea no encontrada");return}S({id:r.id,container_id:r.container_id,pallet_id:r.pallet_id,sku:r.sku,qty:r.qty,source_import_line_id:r.source_import_line_id,pallet_code:r.pallets?.pallet_code||"—",descripcion:r.import_lines?.descripcion||"—",tienda:r.import_lines?.tienda||"—"})}catch(r){console.error("Error cargando detalles de línea:",r),b("Error al cargar los detalles")}},g=async()=>{if(!(!s||!n)){u(!0),b("");try{const{data:r}=await x.from("containers").select("status").eq("id",s.container_id).maybeSingle();if(!r)throw new Error("Contenedor no encontrado");if(r.status==="DISPATCHED")throw new Error("No se pueden reversar líneas de contenedores despachados");const{data:p}=await x.from("pallet_inventory").select("qty_available").eq("pallet_id",s.pallet_id).eq("sku",s.sku).maybeSingle();if(!p)throw new Error("Inventario del pallet no encontrado");const{error:y}=await x.from("pallet_inventory").update({qty_available:p.qty_available+s.qty}).eq("pallet_id",s.pallet_id).eq("sku",s.sku);if(y)throw y;const{data:j}=await x.from("import_lines").select("qty_confirmed, qty_to_send").eq("id",s.source_import_line_id).maybeSingle();if(!j)throw new Error("Línea de importación no encontrada");const N=Math.max(0,j.qty_confirmed-s.qty),w=N===0?"PENDING":N>=j.qty_to_send?"DONE":"PARTIAL",{error:k}=await x.from("import_lines").update({qty_confirmed:N,status:w,...w!=="DONE"?{done_at:null,done_by:null}:{}}).eq("id",s.source_import_line_id);if(k)throw k;const{error:E}=await x.from("container_lines").delete().eq("id",s.id);if(E)throw E;await x.from("scan_events").insert({pallet_id:s.pallet_id,event_type:"REVERSE",sku:s.sku,tienda:s.tienda,qty:s.qty,user_id:n.id,notes:"Reversión de línea de contenedor"}),t("success","Línea reversada",`${s.qty} uds de ${s.sku} devueltas al pallet ${s.pallet_code}`),o(),i()}catch(r){console.error("Error reversando línea:",r),b(r.message||"Error al reversar la línea"),t("error","Error",r.message||"No se pudo reversar la línea")}finally{u(!1)}}};return s?e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Reversar Línea"}),e.jsx("button",{onClick:i,disabled:m,className:"text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-2xl"})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-alert-line text-amber-600 text-xl mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-amber-900 mb-1",children:"Confirmar reversión"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Esta acción devolverá la cantidad al pallet de origen y actualizará el estado del pedido."})]})]})}),v&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm mb-6",children:v}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Pallet:"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:s.pallet_code})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"SKU:"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:s.sku})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Descripción:"}),e.jsx("span",{className:"text-sm text-gray-900",children:s.descripcion})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-100",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Tienda:"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:s.tienda})]}),e.jsxs("div",{className:"flex items-center justify-between py-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Cantidad a reversar:"}),e.jsxs("span",{className:"text-lg font-bold text-amber-600",children:[s.qty," uds"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:i,disabled:m,className:"flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors whitespace-nowrap cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancelar"}),e.jsx("button",{onClick:g,disabled:m,className:"flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-lg font-medium hover:from-amber-600 hover:to-amber-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap cursor-pointer",children:m?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line mr-2 animate-spin"}),"Reversando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-arrow-go-back-line mr-2"}),"Confirmar Reversión"]})})]})]})]})}):e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-6",children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-teal-500"})})})})}function H(){const{id:d}=A(),[i,o]=c.useState(null),[n,t]=c.useState([]),[m,u]=c.useState(""),[s,S]=c.useState(""),[v,b]=c.useState(!0),[_,g]=c.useState(""),[r,p]=c.useState(null);c.useEffect(()=>{d&&y()},[d]);const y=async()=>{b(!0),g("");try{const{data:a,error:l}=await x.from("containers").select(`
            id, code, tienda, status, created_at, closed_at, created_by,
            container_lines(
              id, qty, sku, pallet_id,
              pallets(id, pallet_code, ubicacion),
              import_lines:source_import_line_id(id, descripcion, barcode, tienda, camion)
            )
          `).eq("id",d).maybeSingle();if(l)throw l;if(!a){g("Contenedor no encontrado");return}o({id:a.id,code:a.code,tienda:a.tienda,status:a.status,created_at:a.created_at,closed_at:a.closed_at,created_by:a.created_by});const h=a.container_lines??[];if(t(h),h.length>0&&h[0].import_lines?.camion&&S(h[0].import_lines.camion),a.created_by){const{data:f,error:q}=await x.from("users").select("email, full_name").eq("auth_id",a.created_by).maybeSingle();if(q)throw q;f&&u(f.full_name||f.email)}}catch(a){console.error("Error cargando contenedor:",a),g("Error al cargar el contenedor")}finally{b(!1)}},j=a=>{p(a)},N=()=>{y()},w=c.useMemo(()=>{const a=new Map;return n.forEach(l=>{const h=l.pallets?.pallet_code??"—",f=`${h}|${l.sku}`;if(a.has(f)){const q=a.get(f);q.qty+=Number(l.qty)||0}else a.set(f,{id:l.id,pallet_code:h,ubicacion:l.pallets?.ubicacion??"",sku:l.sku,descripcion:l.import_lines?.descripcion??"",barcode:l.import_lines?.barcode??"",qty:Number(l.qty)||0})}),Array.from(a.values())},[n]),k=c.useMemo(()=>{const a=new Set;return n.forEach(l=>{l.pallet_id&&a.add(l.pallet_id)}),a.size},[n]),E=c.useMemo(()=>{const a=new Set;return n.forEach(l=>{l.sku&&a.add(l.sku)}),a.size},[n]),D=c.useMemo(()=>n.reduce((a,l)=>a+(Number(l.qty)||0),0),[n]);return v?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-teal-500"})}):_?e.jsxs("div",{className:"text-center py-20",children:[e.jsx("div",{className:"w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center mx-auto mb-4",children:e.jsx("i",{className:"ri-error-warning-line text-3xl text-red-400"})}),e.jsx("p",{className:"text-sm text-gray-600",children:_})]}):i?e.jsxs("div",{className:"space-y-6",children:[e.jsx(T,{code:i.code,tienda:i.tienda,camion:s,status:i.status,createdAt:i.created_at,closedAt:i.closed_at,createdByEmail:m}),e.jsx(M,{totalPallets:k,totalSkus:E,totalUnits:D}),e.jsx($,{rows:w,containerStatus:i.status,onReverse:j}),r&&e.jsx(U,{lineId:r,onClose:()=>p(null),onSuccess:N})]}):null}export{H as default};
//# sourceMappingURL=page-CSzIpzYV.js.map
